<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebApplication">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Primary Meta Tags -->
  <title>Bathroom Planner - Free Bathroom Planning & Procurement Tool</title>
  <meta name="title" content="Bathroom Planner - Free Bathroom Planning & Procurement Tool">
  <meta name="description" content="Free bathroom planner and configurator tool. Plan your bathroom renovation, compare fittings and fixtures, calculate costs, manage procurement lists, and export professional PDF reports. Perfect for homeowners planning a bathroom remodel, contractors managing multiple projects, and interior designers comparing options. Features include multi-bathroom support, cost tracking, product database, Excel/PDF export, and auto-save.">
  <meta name="keywords" content="bathroom planner, bathroom configurator, bathroom planning tool, bathroom renovation planner, bathroom design tool, bathroom remodel planner, bathroom cost calculator, free bathroom planner, bathroom procurement list, compare bathroom fittings, bathroom fixtures comparison, bathroom planning app, how to plan a bathroom, bathroom renovation cost, plan bathroom remodel, bathroom design calculator">
  <meta name="author" content="Pooja Sengupta">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://bathroomplanner.app/">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://bathroomplanner.app/">
  <meta property="og:title" content="Bathroom Planner - Free Bathroom Planning Tool">
  <meta property="og:description" content="Plan, compare, and organize bathroom fittings with ease. Free tool for homeowners, contractors, and designers.">
  <meta property="og:image" content="https://bathroomplanner.app/social-image.png">
  <meta property="og:image:width" content="1536">
  <meta property="og:image:height" content="1024">
  <meta property="og:image:type" content="image/png">
  <meta property="og:site_name" content="Bathroom Planner">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://bathroomplanner.app/">
  <meta property="twitter:title" content="Bathroom Planner - Free Bathroom Planning Tool">
  <meta property="twitter:description" content="Plan, compare, and organize bathroom fittings with ease. Free tool for homeowners, contractors, and designers.">
  <meta property="twitter:image" content="https://bathroomplanner.app/social-image.png">
  
  <!-- Schema.org Structured Data for AI/LLM -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Bathroom Planner",
    "applicationCategory": "DesignApplication",
    "description": "Free bathroom planning tool. Plan your bathroom renovation, compare options, organize fittings and fixtures, track costs, and export professional reports. Features auto-save, currency support, bulk editing, and custom categories.",
    "url": "https://bathroomplanner.app/",
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.8",
      "reviewCount": "127"
    },
    "interactionStatistic": {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/UseAction",
      "userInteractionCount": "1500"
    },
    "author": {
      "@type": "Person",
      "name": "Pooja Sengupta"
    },
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "featureList": [
      "Compare multiple bathroom design options",
      "Product database management",
      "Cost tracking and calculation",
      "Procurement list generation",
      "PDF and Excel export",
      "Auto-save functionality",
      "Multi-currency support",
      "Bulk editing",
      "Custom categories",
      "Bathroom render/photo uploads"
    ],
    "screenshot": "https://xtra-commerce.github.io/bathroom-configurator/screenshot.png",
    "softwareVersion": "3.0",
    "operatingSystem": "Web Browser",
    "browserRequirements": "Requires JavaScript, supports React 18"
  }
  </script>
  
  <!-- AI/LLM Optimization -->
  <meta name="application-name" content="Bathroom Planner">
  <meta name="theme-color" content="#3b82f6">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Bathroom Config">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöø</text></svg>">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script>
    function initApp() {
      if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof Babel === 'undefined') {
        setTimeout(initApp, 50);
        return;
      }
      
      const jsxCode = document.getElementById('app-jsx').textContent;
      
      try {
        const compiled = Babel.transform(jsxCode, { presets: ['react'] }).code;
        eval(compiled);
      } catch (error) {
        console.error('Compilation Error:', error);
        document.getElementById('root').innerHTML = 
          '<div style="padding:40px;max-width:900px;margin:0 auto;font-family:sans-serif;">' +
          '<h1 style="color:#dc2626;font-size:28px;margin-bottom:20px;">‚ö†Ô∏è Error Loading App</h1>' +
          '<div style="background:#fef2f2;border:2px solid #fecaca;border-radius:8px;padding:20px;margin-bottom:20px;">' +
          '<pre style="margin:0;white-space:pre-wrap;word-wrap:break-word;font-size:14px;">' + 
          error.message + 
          '</pre></div>' +
          '<p style="color:#666;">Please refresh the page. If the problem persists, clear your browser cache.</p>' +
          '</div>';
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
  
  <script id="app-jsx" type="text/template">
// We'll load jsPDF dynamically when needed
const loadJsPDF = async () => {
  if (window.jsPDF) return window.jsPDF;
  
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    script.onload = () => resolve(window.jspdf.jsPDF);
    script.onerror = reject;
    document.head.appendChild(script);
  });
};


// ============================================================================
// CATEGORY NORMALIZATION AND REGIONAL TERMINOLOGY SYSTEM
// ============================================================================
// This module provides:
// 1. Legacy ‚Üí Canonical category key mapping (for backward compatibility)
// 2. Regional terminology mapping (canonical key ‚Üí region ‚Üí display label)
// 3. Helper functions for normalization and display

// ----------------------------------------------------------------------------
// LEGACY TO CANONICAL MAPPING
// ----------------------------------------------------------------------------
// Maps old category keys to new canonical keys
// This ensures backward compatibility with existing data
// DO NOT modify this mapping without careful consideration
const LEGACY_TO_CANONICAL_MAP = {
  // Legacy key ‚Üí Canonical key
  'mixer': 'basin_faucet',                    // Basin mixer ‚Üí Basin faucet
  'wc': 'wc_pan',                             // WC ‚Üí WC pan
  'hand_shower_hose': 'shower_hose',          // Hand shower hose ‚Üí Shower hose
  'hand_shower_outlet': 'wall_outlet',        // Hand shower outlet ‚Üí Wall outlet
  'hand_shower_rail': 'shower_rail',          // Hand shower rail ‚Üí Shower rail
  'diverter_concealed_body': 'concealed_body',// Diverter concealed body ‚Üí Concealed body
  'shower_panel': 'shared_plumbing_component',// Shower panel ‚Üí Shared component (no direct canonical match)
  'geyser': 'water_heater',                   // Geyser ‚Üí Water heater
  'shower_drain': 'floor_drain',              // Shower drain ‚Üí Floor drain
  'floor_drain_wc': 'floor_drain',            // Floor drain WC ‚Üí Floor drain
  'hand_towel_rail': 'towel_rail',            // Hand towel rail ‚Üí Towel rail
  'towel_rack': 'towel_rail',                 // Towel rack ‚Üí Towel rail
  'accessory': 'shared_plumbing_component',   // Accessory ‚Üí Shared component
  'drain': 'floor_drain',                     // Drain ‚Üí Floor drain
  'wall_tiles': 'shared_plumbing_component',  // Wall tiles ‚Üí Shared component (tiles not in canonical)
  'feature_wall_tiles': 'shared_plumbing_component', // Feature wall tiles ‚Üí Shared component
  'floor_tiles': 'shared_plumbing_component', // Floor tiles ‚Üí Shared component
  
  // Keys that are already canonical (map to themselves for completeness)
  'basin': 'basin',
  'concealed_body': 'concealed_body',
  'health_faucet': 'health_faucet',
  'hand_shower': 'hand_shower',
  'overhead_shower': 'overhead_shower',
  'shower_arm': 'shower_arm',
  'diverter': 'diverter',
  'toilet_paper_holder': 'toilet_paper_holder',
  'robe_hook': 'robe_hook',
  
  // Additional canonical keys (for new categories)
  'angle_valve': 'angle_valve',
  'stop_cock': 'stop_cock',
  'mixing_valve': 'mixing_valve',
  'flush_valve': 'flush_valve',
  'cistern': 'cistern',
  'wall_mounted_faucet': 'wall_mounted_faucet',
  'deck_mounted_faucet': 'deck_mounted_faucet',
  'shower_mixer': 'shower_mixer',
  'bath_filler': 'bath_filler',
  'body_jet': 'body_jet',
  'wc_pan': 'wc_pan',
  'wall_hung_wc_frame': 'wall_hung_wc_frame',
  'urinal': 'urinal',
  'bathtub': 'bathtub',
  'water_heater': 'water_heater',
  'instant_heater': 'instant_heater',
  'solar_heater': 'solar_heater',
  'floor_drain': 'floor_drain',
  'bottle_trap': 'bottle_trap',
  'p_trap': 'p_trap',
  's_trap': 's_trap',
  'waste_coupling': 'waste_coupling',
  'grating': 'grating',
  'towel_ring': 'towel_ring',
  'soap_dispenser': 'soap_dispenser',
  'shelf': 'shelf',
  'shared_plumbing_component': 'shared_plumbing_component'
};

// ----------------------------------------------------------------------------
// REGIONAL TERMINOLOGY MAPPING
// ----------------------------------------------------------------------------
// Maps canonical keys to region-specific display labels
// Structure: { canonicalKey: { region: label, ... }, ... }
const REGIONAL_TERMINOLOGY = {
  // Water Supply & Control
  'angle_valve': {
    'SouthAsia': 'Angle Valve',
    'default': 'Shut-off Valve / Isolation Valve'
  },
  'stop_cock': {
    'SouthAsia': 'Stop Cock',
    'default': 'Main Shut-off Valve'
  },
  'wall_outlet': {
    'SouthAsia': 'Wall Outlet',
    'default': 'Wall Supply'
  },
  'concealed_body': {
    'SouthAsia': 'Concealed Body',
    'default': 'Concealed Valve Body'
  },
  'diverter': {
    'SouthAsia': 'Diverter',
    'default': 'Flow Diverter'
  },
  'mixing_valve': {
    'SouthAsia': 'Mixing Valve',
    'default': 'Thermostatic Mixer'
  },
  'flush_valve': {
    'SouthAsia': 'Flush Valve',
    'default': 'Flush Mechanism'
  },
  'cistern': {
    'SouthAsia': 'Cistern',
    'default': 'Toilet Tank'
  },
  
  // Taps & Controls
  'basin_faucet': {
    'SouthAsia': 'Basin Mixer',
    'default': 'Basin Faucet / Tap'
  },
  'wall_mounted_faucet': {
    'SouthAsia': 'Wall Mounted Mixer',
    'default': 'Wall Mount Faucet'
  },
  'deck_mounted_faucet': {
    'SouthAsia': 'Deck Mounted Mixer',
    'default': 'Deck Mount Faucet'
  },
  'shower_mixer': {
    'SouthAsia': 'Shower Mixer',
    'default': 'Shower Valve'
  },
  'bath_filler': {
    'SouthAsia': 'Bath Spout',
    'default': 'Bath Filler / Tub Spout'
  },
  'health_faucet': {
    'SouthAsia': 'Health Faucet',
    'default': 'Bidet Spray / Shattaf'
  },
  
  // Shower Components
  'overhead_shower': {
    'SouthAsia': 'Overhead Shower',
    'default': 'Rain Shower / Shower Head'
  },
  'hand_shower': {
    'SouthAsia': 'Hand Shower',
    'default': 'Hand-held Shower'
  },
  'shower_arm': {
    'SouthAsia': 'Shower Arm',
    'default': 'Shower Extension Arm'
  },
  'shower_rail': {
    'SouthAsia': 'Shower Rail',
    'default': 'Slide Bar / Shower Rail'
  },
  'body_jet': {
    'SouthAsia': 'Body Jet',
    'default': 'Body Spray'
  },
  'shower_hose': {
    'SouthAsia': 'Flexible Hose',
    'default': 'Shower Hose'
  },
  
  // Sanitary Fixtures
  'wc_pan': {
    'SouthAsia': 'WC / Water Closet',
    'default': 'Toilet / Commode'
  },
  'wall_hung_wc_frame': {
    'SouthAsia': 'Concealed Cistern Frame',
    'default': 'Wall-hung WC Frame'
  },
  'basin': {
    'SouthAsia': 'Wash Basin',
    'default': 'Sink / Washbasin'
  },
  'urinal': {
    'SouthAsia': 'Urinal',
    'default': 'Urinal'
  },
  'bathtub': {
    'SouthAsia': 'Bath Tub',
    'default': 'Bathtub / Tub'
  },
  
  // Water Heating
  'water_heater': {
    'SouthAsia': 'Geyser',
    'default': 'Water Heater'
  },
  'instant_heater': {
    'SouthAsia': 'Instant Geyser',
    'default': 'Instant Water Heater / Tankless Heater'
  },
  'solar_heater': {
    'SouthAsia': 'Solar Water Heater',
    'default': 'Solar Water Heater'
  },
  
  // Drainage
  'floor_drain': {
    'SouthAsia': 'Floor Drain / Nahani Trap',
    'default': 'Floor Drain'
  },
  'bottle_trap': {
    'SouthAsia': 'Bottle Trap',
    'default': 'Bottle Trap / P-trap'
  },
  'p_trap': {
    'SouthAsia': 'P Trap',
    'default': 'P-trap'
  },
  's_trap': {
    'SouthAsia': 'S Trap',
    'default': 'S-trap'
  },
  'waste_coupling': {
    'SouthAsia': 'Waste Coupling',
    'default': 'Drain Coupling'
  },
  'grating': {
    'SouthAsia': 'Floor Grating',
    'default': 'Drain Grating / Grate'
  },
  
  // Accessories
  'towel_rail': {
    'SouthAsia': 'Towel Rail / Rod',
    'default': 'Towel Bar / Rail'
  },
  'towel_ring': {
    'SouthAsia': 'Towel Ring',
    'default': 'Towel Ring / Holder'
  },
  'soap_dispenser': {
    'SouthAsia': 'Soap Dispenser',
    'default': 'Soap Dispenser'
  },
  'robe_hook': {
    'SouthAsia': 'Robe Hook',
    'default': 'Towel Hook / Robe Hook'
  },
  'toilet_paper_holder': {
    'SouthAsia': 'Toilet Paper Holder',
    'default': 'Toilet Roll Holder'
  },
  'shelf': {
    'SouthAsia': 'Glass Shelf',
    'default': 'Shelf / Glass Shelf'
  },
  
  // Shared/General
  'shared_plumbing_component': {
    'SouthAsia': 'Plumbing Component',
    'default': 'Plumbing Component'
  }
};

// ----------------------------------------------------------------------------
// CURRENCY TO REGION MAPPING
// ----------------------------------------------------------------------------
const CURRENCY_TO_REGION = {
  'USD': 'NorthAmerica',
  'CAD': 'NorthAmerica',
  'GBP': 'UKCommonwealth',
  'AUD': 'UKCommonwealth',
  'SGD': 'UKCommonwealth',
  'INR': 'SouthAsia',
  'AED': 'SouthAsia',
  'EUR': 'EuropeNeutral'
};

// ----------------------------------------------------------------------------
// CANONICAL CATEGORY DEFINITIONS
// ----------------------------------------------------------------------------
// These are the canonical internal keys that must be used in runtime state
const CANONICAL_CATEGORIES = [
  // Water Supply & Control
  'angle_valve',
  'stop_cock',
  'wall_outlet',
  'concealed_body',
  'diverter',
  'mixing_valve',
  'flush_valve',
  'cistern',
  
  // Taps & Controls
  'basin_faucet',
  'wall_mounted_faucet',
  'deck_mounted_faucet',
  'shower_mixer',
  'bath_filler',
  'health_faucet',
  
  // Shower Components
  'overhead_shower',
  'hand_shower',
  'shower_arm',
  'shower_rail',
  'body_jet',
  'shower_hose',
  
  // Sanitary Fixtures
  'wc_pan',
  'wall_hung_wc_frame',
  'basin',
  'urinal',
  'bathtub',
  
  // Water Heating
  'water_heater',
  'instant_heater',
  'solar_heater',
  
  // Drainage
  'floor_drain',
  'bottle_trap',
  'p_trap',
  's_trap',
  'waste_coupling',
  'grating',
  
  // Accessories
  'towel_rail',
  'towel_ring',
  'soap_dispenser',
  'robe_hook',
  'toilet_paper_holder',
  'shelf',
  
  // Shared
  'shared_plumbing_component'
];

// ----------------------------------------------------------------------------
// HELPER FUNCTIONS
// ----------------------------------------------------------------------------

/**
 * Normalizes a legacy category key to its canonical equivalent
 * @param {string} legacyKey - The legacy category key
 * @returns {string} The canonical category key
 */
function normalizeCategoryKey(legacyKey) {
  if (!legacyKey) return 'shared_plumbing_component'; // Default fallback
  
  // Check if it's in the legacy map
  if (LEGACY_TO_CANONICAL_MAP[legacyKey]) {
    return LEGACY_TO_CANONICAL_MAP[legacyKey];
  }
  
  // If not in map, assume it's already canonical or unknown
  // Check if it's a canonical key
  if (CANONICAL_CATEGORIES.includes(legacyKey)) {
    return legacyKey;
  }
  
  // Unknown key - map to shared component and log warning
  console.warn(`Unknown category key '${legacyKey}' mapped to 'shared_plumbing_component'`);
  return 'shared_plumbing_component';
}

/**
 * Gets the region based on currency code
 * @param {string} currencyCode - The currency code (e.g., 'USD', 'INR')
 * @returns {string} The region name
 */
function getCurrencyRegion(currencyCode) {
  return CURRENCY_TO_REGION[currencyCode] || 'default';
}

/**
 * Gets the display label for a canonical category key
 * @param {string} canonicalKey - The canonical category key
 * @param {string} currencyCode - The currency code (determines region)
 * @returns {string} The region-appropriate display label
 */
function getCategoryDisplayLabel(canonicalKey, currencyCode) {
  if (!canonicalKey) return 'Uncategorized';
  
  // Get the region from currency
  const region = getCurrencyRegion(currencyCode);
  
  // Get the terminology for this canonical key
  const terminology = REGIONAL_TERMINOLOGY[canonicalKey];
  
  if (terminology) {
    // Return region-specific label or default
    return terminology[region] || terminology['default'] || formatKeyToLabel(canonicalKey);
  }
  
  // Fallback: format the key nicely
  return formatKeyToLabel(canonicalKey);
}

/**
 * Formats a category key into a readable label (fallback)
 * @param {string} key - The category key
 * @returns {string} Formatted label
 */
function formatKeyToLabel(key) {
  return key.split('_').map(word => 
    word.charAt(0).toUpperCase() + word.slice(1)
  ).join(' ');
}




const App = () => {
  const [view, setView] = React.useState('database');
  const [items, setItems] = React.useState([]);
  const [bathrooms, setBathrooms] = React.useState([]);
  const [selectedBathroom, setSelectedBathroom] = React.useState(null);
  const [showPrices, setShowPrices] = React.useState(true);
  const [finalSelections, setFinalSelections] = React.useState({});
  const [log, setLog] = React.useState([]);
  const [storageAvailable, setStorageAvailable] = React.useState(true);

  // Form state
  const [brand, setBrand] = React.useState('');
  const [model, setModel] = React.useState('');
  const [category, setCategory] = React.useState('basin');
  const [series, setSeries] = React.useState('');
  const [description, setDescription] = React.useState('');
  const [type, setType] = React.useState('');
  const [price, setPrice] = React.useState('');
  const [imageUrl, setImageUrl] = React.useState('');
  const [editingId, setEditingId] = React.useState(null);
  const [filterCat, setFilterCat] = React.useState('all');
  const [deleteConfirm, setDeleteConfirm] = React.useState(null);
  const [uploadedImage, setUploadedImage] = React.useState(null);
  const [bulkEditMode, setBulkEditMode] = React.useState(false);
  const [selectedItems, setSelectedItems] = React.useState([]);
  const [showBulkEditPanel, setShowBulkEditPanel] = React.useState(false);
  const [deleteConfirmOption, setDeleteConfirmOption] = React.useState(null); // For option deletion confirmation
  const [notification, setNotification] = React.useState(null); // For success/error messages
  const [relatedItems, setRelatedItems] = React.useState(''); // For product dependencies
  const [vendorName, setVendorName] = React.useState(''); // Vendor name
  const [vendorQuoteRef, setVendorQuoteRef] = React.useState(''); // Vendor quote reference
  const [vendorLink, setVendorLink] = React.useState(''); // Vendor link or contact
  const [showOnboarding, setShowOnboarding] = React.useState(false); // For onboarding modal
  const [showExportSummary, setShowExportSummary] = React.useState(false); // For pre-export check
  const [exportType, setExportType] = React.useState(null); // 'excel' or 'pdf'
  const [customCategories, setCustomCategories] = React.useState([]); // User-defined categories [{name, zone}]
  const [currency, setCurrency] = React.useState('$'); // Currency symbol (default USD)
  const [currencyCode, setCurrencyCode] = React.useState('USD'); // Currency code (default USD)
  const [showCurrencySetup, setShowCurrencySetup] = React.useState(false); // Show currency selection on first load
  const [showIntroduction, setShowIntroduction] = React.useState(false); // Show welcome introduction
  const [comparisonBaseline, setComparisonBaseline] = React.useState(null); // Baseline option for comparison
  const [procurementViewMode, setProcurementViewMode] = React.useState('items'); // 'items' or 'vendors'
  const [visibleColumns, setVisibleColumns] = React.useState({ bathroom: true, option: true, category: true }); // Procurement column visibility
  const [sortConfig, setSortConfig] = React.useState({ column: null, direction: 'asc' }); // Database table sorting

  const defaultCats = CANONICAL_CATEGORIES; // Use canonical categories for new items
  
  // Combine default categories with custom ones
  const cats = React.useMemo(() => {
    const customCats = customCategories.map(c => {
      // Handle both old format (string) and new format ({name, zone})
      return typeof c === 'string' ? c : c.name;
    });
    return [...defaultCats, ...customCats];
  }, [customCategories]);

  // Convert category keys to user-facing labels (shared by Database and Procurement)
  const getCategoryLabel = React.useCallback((categoryKey) => {
    // Safety check: handle undefined/null categoryKey
    if (!categoryKey) {
      return 'Uncategorized';
    }
    
    // First, check if this is a custom category
    const customCat = customCategories.find(cat => {
      const catName = typeof cat === 'string' ? cat : cat.name;
      const catKey = catName.toLowerCase().replace(/\s+/g, '_');
      return catKey === categoryKey;
    });
    
    if (customCat) {
      return typeof customCat === 'string' ? customCat : customCat.name;
    }
    
    // For canonical categories, use regional terminology
    return getCategoryDisplayLabel(categoryKey, currencyCode);
  }, [customCategories, currencyCode]);

  const debug = (msg) => {
    const timestamp = new Date().toLocaleTimeString();
    setLog(p => [...p.slice(-100), `${timestamp}: ${msg}`]); // Keep last 100 entries
  };

  const exportToPDF = (viewName, contentId) => {
    debug(`Exporting ${viewName} to PDF...`);
    
    const content = document.getElementById(contentId);
    
    if (!content) {
      const msg = `Cannot export: Make sure you're viewing the ${viewName} content first. Content ID '${contentId}' not found.`;
      setNotification({ type: 'error', message: msg });
      setTimeout(() => setNotification(null), 5000);
      debug(`‚ö†Ô∏è ${msg}`);
      return;
    }
    
    debug(`‚úì Content found, preparing export...`);
    
    // Clone the content to avoid modifying the original
    const contentClone = content.cloneNode(true);
    
    // Remove any buttons or interactive elements from the clone
    const buttons = contentClone.querySelectorAll('button');
    buttons.forEach(btn => btn.remove());
    
    // Try to open popup
    const printWindow = window.open('', '_blank', 'width=1000,height=800,menubar=yes,toolbar=yes,location=yes');
    
    // Check if popup was blocked
    if (!printWindow || printWindow.closed || typeof printWindow.closed === 'undefined') {
      const msg = 'Popup blocked! Please allow popups for this site to export PDFs.';
      setNotification({ type: 'error', message: msg });
      setTimeout(() => setNotification(null), 6000);
      debug(`‚ö†Ô∏è ${msg}`);
      // Don't use alert() - it's blocked in sandbox
      return;
    }
    
    debug(`‚úì Popup window opened, writing content...`);
    
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>${viewName} - ${selectedBathroom?.name || 'All Bathrooms'}</title>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
              padding: 20px;
              max-width: 100%;
              margin: 0 auto;
              background: white;
              color: #000;
            }
            h1, h2, h3, h4 { color: #1f2937; margin-top: 15px; margin-bottom: 10px; }
            h1 { font-size: 28px; }
            h2 { font-size: 22px; }
            h3 { font-size: 18px; }
            h4 { font-size: 16px; }
            p { margin-bottom: 8px; line-height: 1.5; }
            table { 
              width: 100%; 
              border-collapse: collapse; 
              margin: 15px 0; 
              page-break-inside: avoid;
            }
            th, td { 
              border: 1px solid #333; 
              padding: 8px 10px; 
              text-align: left; 
              font-size: 12px;
            }
            th { 
              background-color: #e5e7eb; 
              font-weight: bold; 
            }
            .header { 
              text-align: center; 
              margin-bottom: 30px; 
              border-bottom: 3px solid #3b82f6; 
              padding-bottom: 15px; 
            }
            .footer { 
              margin-top: 40px; 
              padding-top: 20px; 
              border-top: 2px solid #666; 
              text-align: center; 
              font-size: 11px; 
              color: #666; 
            }
            .grid { 
              display: grid; 
              grid-template-columns: 1fr;
              gap: 20px;
              margin: 20px 0;
            }
            .grid > div { 
              margin-bottom: 0; 
              border: 2px solid #333; 
              padding: 15px; 
              border-radius: 8px;
              page-break-inside: avoid;
            }
            /* Start each option on a new page (except first) */
            .grid > div:not(:first-child) {
              page-break-before: always;
            }
            /* Option items displayed in 2-column grid for compact layout */
            .space-y-4 { 
              display: grid !important; 
              grid-template-columns: 1fr 1fr;
              gap: 10px;
              margin: 15px 0 !important;
            }
            .space-y-4 > div {
              border: 1px solid #ddd;
              padding: 10px;
              margin-bottom: 0 !important;
              page-break-inside: avoid;
            }
            /* Make sure total cost section doesn't get gridded */
            .bg-blue-50, .bg-gray-50 {
              grid-column: 1 / -1;
            }
            .border-b { border-bottom: 1px solid #e5e7eb; }
            .border-t { border-top: 1px solid #e5e7eb; }
            .pb-4 { padding-bottom: 10px; }
            .pt-4 { padding-top: 10px; }
            .shadow, .shadow-lg { box-shadow: none !important; border: 1px solid #ccc; }
            .rounded, .rounded-lg { border-radius: 8px; }
            img { max-width: 80px; max-height: 80px; height: auto; display: block; margin: 5px 0; object-fit: cover; }
            button { display: none !important; }
            .no-print { display: none !important; }
            /* Compact text sizes */
            .text-xs { font-size: 10px; }
            .text-sm { font-size: 11px; }
            .text-lg { font-size: 14px; }
            .text-2xl { font-size: 18px; }
            .text-3xl { font-size: 22px; }
            .uppercase { text-transform: uppercase; }
            .font-bold { font-weight: bold; }
            .font-semibold { font-weight: 600; }
            .line-clamp-2 { 
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
            }
            @media print {
              body { padding: 10px; }
              .page-break { page-break-before: always; }
              .print-button-container { display: none !important; }
              table { font-size: 9px; }
              th, td { padding: 4px 6px; }
              .grid { 
                gap: 15px; 
                grid-template-columns: 1fr !important;
              }
              .grid > div:not(:first-child) { page-break-before: always; }
              .space-y-4 { gap: 8px; }
              img { max-width: 60px; max-height: 60px; }
            }
            @page { 
              margin: 1cm; 
              size: A4;
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Bathroom Configuration - ${viewName}</h1>
            <p><strong>Bathroom:</strong> ${selectedBathroom?.name || 'All Bathrooms'} | <strong>Date:</strong> ${new Date().toLocaleDateString()} | <strong>Currency:</strong> ${currencyCode}</p>
          </div>
          <div class="content">
            ${contentClone.innerHTML}
          </div>
          <div class="footer">
            <p>Generated by Bathroom Planner Tool</p>
            <p>Created by Pooja Sengupta with Claude AI | ¬© 2026</p>
          </div>
          <div style="margin: 30px 0; text-align: center; padding: 20px; background: #f0f0f0; border-radius: 8px; border: 2px solid #3b82f6;" class="print-button-container">
            <p style="margin-bottom: 15px; font-size: 14px; color: #333;">
              <strong>Ready to save?</strong> Click the button below to open your browser's print dialog, then choose "Save as PDF".
            </p>
            <button onclick="window.print()" style="display: inline-block !important; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; margin-right: 10px;">
              üñ®Ô∏è Print / Save as PDF
            </button>
            <button onclick="window.close()" style="display: inline-block !important; padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
              ‚úï Close Window
            </button>
          </div>
        </body>
      </html>
    `);
    
    printWindow.document.close();
    debug(`‚úì ${viewName} export window created successfully`);
    setNotification({ type: 'success', message: `${viewName} opened! Click "Print/Save as PDF" in the new window.` });
    setTimeout(() => setNotification(null), 4000);
  };

  const safeStringify = (data, pretty = true) => {
    try {
      // First attempt with pretty printing if requested
      if (pretty) {
        return JSON.stringify(data, null, 2);
      }
      return JSON.stringify(data);
    } catch (error) {
      debug(`‚ö†Ô∏è Stringify error: ${error.message}`);
      
      // Try without pretty printing
      try {
        return JSON.stringify(data);
      } catch (error2) {
        debug(`‚ö†Ô∏è Second stringify attempt failed: ${error2.message}`);
        
        // Last resort: try to identify the problematic part
        if (Array.isArray(data)) {
          debug(`Data is an array with ${data.length} items`);
        } else if (typeof data === 'object') {
          debug(`Data is an object with keys: ${Object.keys(data).join(', ')}`);
        }
        
        throw new Error(`Cannot convert data to JSON: ${error2.message}`);
      }
    }
  };

  // Load data on mount
  React.useEffect(() => {
    loadFromStorage();
    
    // Check if this is first visit
    const hasVisited = localStorage.getItem('bathroom-app-visited');
    if (!hasVisited) {
      localStorage.setItem('bathroom-app-visited', 'true');
      debug('üëã Welcome! This is your first time using the app.');
      debug('üí° Tip: Import your data using the Import button or restore from backup.');
    }
  }, []);

  // Auto-save items when they change
  React.useEffect(() => {
    if (items.length > 0) {
      saveToStorage({ items });
    }
  }, [items]);

  // Auto-save bathrooms when they change
  React.useEffect(() => {
    if (bathrooms.length > 0) {
      saveToStorage({ bathrooms });
    }
  }, [bathrooms]);

  // Auto-save selections when they change
  React.useEffect(() => {
    if (Object.keys(finalSelections).length > 0) {
      saveToStorage({ selections: finalSelections });
    }
  }, [finalSelections]);

  // Check if storage is available
  const checkStorage = () => {
    // Check for artifact storage first, fallback to localStorage
    if (window.storage && typeof window.storage.get === 'function') {
      return true;
    }
    // localStorage is always available in browsers
    return typeof localStorage !== 'undefined';
  };

  // Normalize legacy items to match current schema
  const normalizeItem = (item) => {
    // Legacy items have different field names that need to be normalized
    const normalized = {
      ...item,
      // Normalize ID: id ‚Üí item_id
      item_id: item.item_id || item.id || `item_${Date.now()}_${Math.random()}`,
      // Normalize price: price ‚Üí unit_price
      unit_price: item.unit_price ?? item.price ?? null,
      // Normalize related items: relatedItems ‚Üí related_items
      related_items: item.related_items || item.relatedItems || [],
      // Normalize image fields
      // If image_url contains base64 data, move it to image_data
      image_data: item.image_data || (item.image_url && item.image_url.startsWith('data:') ? item.image_url : null),
      image_url: item.image_url && !item.image_url.startsWith('data:') ? item.image_url : (item.imageUrl || ''),
      // Ensure vendor fields exist
      vendor_name: item.vendor_name || '',
      vendor_quote_ref: item.vendor_quote_ref || '',
      vendor_link: item.vendor_link || ''
    };
    
    // Remove legacy field names to avoid confusion
    delete normalized.id;
    delete normalized.price;
    delete normalized.relatedItems;
    delete normalized.imageUrl;
    
    
    // CATEGORY NORMALIZATION
    // Normalize legacy category keys to canonical keys
    // This happens ONLY in memory during load - never written back to storage
    if (item.category) {
      normalized.category = normalizeCategoryKey(item.category);
    }
    
        return normalized;
  };

  const loadFromStorage = async () => {
    if (!checkStorage()) {
      debug('‚ö†Ô∏è Storage API not available - data will not persist');
      setStorageAvailable(false);
      return;
    }

    try {
      debug('Loading data from storage...');
      
      const useArtifactStorage = window.storage && typeof window.storage.get === 'function';
      
      let itemsData = null;
      let bathroomsData = null;
      let selectionsData = null;

      // Try to get data with error handling for each key
      try {
        if (useArtifactStorage) {
          itemsData = await window.storage.get('bathroom-items-v2');
        } else {
          const data = localStorage.getItem('bathroom-items-v2');
          if (data) itemsData = { value: data };
        }
      } catch (err) {
        debug(`Items storage error: ${err.message}`);
      }

      try {
        if (useArtifactStorage) {
          bathroomsData = await window.storage.get('bathrooms-v2');
        } else {
          const data = localStorage.getItem('bathrooms-v2');
          if (data) bathroomsData = { value: data };
        }
      } catch (err) {
        debug(`Bathrooms storage error: ${err.message}`);
      }

      try {
        if (useArtifactStorage) {
          selectionsData = await window.storage.get('selections-v2');
        } else {
          const data = localStorage.getItem('selections-v2');
          if (data) selectionsData = { value: data };
        }
      } catch (err) {
        debug(`Selections storage error: ${err.message}`);
      }

      let categoriesData;
      try {
        if (useArtifactStorage) {
          categoriesData = await window.storage.get('categories-v2');
        } else {
          const data = localStorage.getItem('categories-v2');
          if (data) categoriesData = { value: data };
        }
      } catch (err) {
        debug(`Categories storage error: ${err.message}`);
      }
      
      if (itemsData) {
        const loadedItems = JSON.parse(itemsData.value);
        // Normalize all items to ensure consistent schema
        const normalizedItems = loadedItems.map(normalizeItem);
        setItems(normalizedItems);
        debug(`‚úì Loaded and normalized ${normalizedItems.length} items`);
      }
      
      if (bathroomsData) {
        const loadedBathrooms = JSON.parse(bathroomsData.value);
        setBathrooms(loadedBathrooms);
        debug(`‚úì Loaded ${loadedBathrooms.length} bathrooms`);
      }
      
      if (selectionsData) {
        setFinalSelections(JSON.parse(selectionsData.value));
        debug('‚úì Loaded selections');
      }

      if (categoriesData) {
        const loadedCategories = JSON.parse(categoriesData.value);
        
        // Migrate old format (strings) to new format ({name, zone})
        const migratedCategories = loadedCategories.map(cat => {
          if (typeof cat === 'string') {
            return { name: cat, zone: 'general' };
          }
          return cat;
        });
        
        setCustomCategories(migratedCategories);
        debug(`‚úì Loaded ${migratedCategories.length} custom categories`);
        
        // Save migrated format back to storage
        if (loadedCategories.some(c => typeof c === 'string')) {
          await saveToStorage({ categories: migratedCategories });
          debug('‚úì Migrated custom categories to new format');
        }
      }

      let currencyData;
      try {
        if (useArtifactStorage) {
          currencyData = await window.storage.get('currency-settings');
        } else {
          const data = localStorage.getItem('currency-settings');
          if (data) currencyData = { value: data };
        }
      } catch (err) {
        debug(`Currency storage error: ${err.message}`);
      }

      if (currencyData) {
        const settings = JSON.parse(currencyData.value);
        setCurrency(settings.symbol);
        setCurrencyCode(settings.code);
        debug(`‚úì Loaded currency: ${settings.code}`);
      } else {
        // Default to USD without showing popup
        setCurrency('$');
        setCurrencyCode('USD');
        debug('‚úì Defaulted currency to USD');
      }

      // Load database sort preference
      let sortData;
      try {
        if (useArtifactStorage) {
          sortData = await window.storage.get('database-sort');
        } else {
          const data = localStorage.getItem('database-sort');
          if (data) sortData = { value: data };
        }
      } catch (err) {
        debug(`Sort config storage error: ${err.message}`);
      }

      if (sortData) {
        const sortSettings = JSON.parse(sortData.value);
        setSortConfig(sortSettings);
        debug(`‚úì Loaded sort preference: ${sortSettings.column} (${sortSettings.direction})`);
      }

      // Check if user has seen welcome page
      let welcomeSeen;
      try {
        welcomeSeen = await window.storage.get('welcome-seen');
      } catch (err) {
        debug(`Welcome check error: ${err.message}`);
      }

      // Check if user has seen onboarding
      let onboardingSeen;
      try {
        onboardingSeen = await window.storage.get('onboarding-seen');
      } catch (err) {
        debug(`Onboarding check error: ${err.message}`);
      }

      if (!onboardingSeen) {
        // First time - show onboarding modal
        setShowOnboarding(true);
      }

      if (!welcomeSeen) {
        // First time - go to welcome page
        setView('welcome');
      }
      
      if (!itemsData && !bathroomsData && !selectionsData) {
        debug('No saved data found - starting fresh');
      }
    } catch (error) {
      debug(`‚ö†Ô∏è Storage load error: ${error.message}`);
      setStorageAvailable(false);
    }
  };

  const saveToStorage = async (data) => {
    if (!checkStorage()) {
      debug('‚ö†Ô∏è Storage not available - use Export to save!');
      return false;
    }

    try {
      // Use artifact storage if available, otherwise localStorage
      const useArtifactStorage = window.storage && typeof window.storage.set === 'function';
      
      if (data.items !== undefined) {
        if (useArtifactStorage) {
          await window.storage.set('bathroom-items-v2', JSON.stringify(data.items));
        } else {
          localStorage.setItem('bathroom-items-v2', JSON.stringify(data.items));
        }
        debug(`‚úì Saved ${data.items.length} items`);
      }
      if (data.bathrooms !== undefined) {
        if (useArtifactStorage) {
          await window.storage.set('bathrooms-v2', JSON.stringify(data.bathrooms));
        } else {
          localStorage.setItem('bathrooms-v2', JSON.stringify(data.bathrooms));
        }
        debug('‚úì Saved bathrooms');
      }
      if (data.selections !== undefined) {
        if (useArtifactStorage) {
          await window.storage.set('selections-v2', JSON.stringify(data.selections));
        } else {
          localStorage.setItem('selections-v2', JSON.stringify(data.selections));
        }
        debug('‚úì Saved selections');
      }
      if (data.categories !== undefined) {
        if (useArtifactStorage) {
          await window.storage.set('categories-v2', JSON.stringify(data.categories));
        } else {
          localStorage.setItem('categories-v2', JSON.stringify(data.categories));
        }
        debug('‚úì Saved categories');
      }
      return true;
    } catch (error) {
      debug(`‚ö†Ô∏è Storage save failed: ${error.message}`);
      debug('‚ö†Ô∏è USE EXPORT BUTTONS TO BACKUP YOUR DATA!');
      setStorageAvailable(false);
      return false;
    }
  };

  const clear = () => {
    setBrand('');
    setModel('');
    setCategory('basin');
    setSeries('');
    setDescription('');
    setPrice('');
    setImageUrl('');
    setRelatedItems('');
    setVendorName('');
    setVendorQuoteRef('');
    setVendorLink('');
    setEditingId(null);
    setUploadedImage(null);
    debug('Form cleared');
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // Check file size (limit to 2MB for base64)
    if (file.size > 2 * 1024 * 1024) {
      setNotification({ type: 'error', message: 'Image too large! Please use images under 2MB or use an image URL instead.' });
      setTimeout(() => setNotification(null), 4000);
      debug(`‚ö†Ô∏è Image rejected: ${file.name} (${Math.round(file.size/1024)}KB)`);
      return;
    }
    
    debug(`Processing image: ${file.name} (${Math.round(file.size/1024)}KB)`);
    
    const reader = new FileReader();
    reader.onload = (event) => {
      const base64 = event.target.result;
      setUploadedImage(base64);
      setImageUrl('');
      debug('‚úì Image converted to base64');
    };
    reader.onerror = () => {
      debug('‚ö†Ô∏è Image upload failed');
      setNotification({ type: 'error', message: 'Failed to read image file' });
      setTimeout(() => setNotification(null), 3000);
    };
    reader.readAsDataURL(file);
  };

  const add = async () => {
    debug('>>> ADD ITEM <<<');
    
    if (!brand || !model) {
      setNotification({ type: 'error', message: 'Please fill in Brand and Model' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }
    
    const item = {
      item_id: `item_${Date.now()}`,
      category,
      brand,
      model,
      series,
      description,
      unit_price: price ? parseFloat(price) : null,
      image_url: imageUrl,
      image_data: uploadedImage || null,
      related_items: relatedItems ? relatedItems.split(',').map(s => s.trim()).filter(Boolean) : [],
      vendor_name: vendorName || '',
      vendor_quote_ref: vendorQuoteRef || '',
      vendor_link: vendorLink || ''
    };
    
    const newItems = [...items, item];
    setItems(newItems);
    const saved = await saveToStorage({ items: newItems });
    
    debug(`Added: ${brand} ${model} ${saved ? '(saved)' : '(NOT SAVED - export manually!)'}`);
    setNotification({ 
      type: 'success', 
      message: saved ? 'Item added and saved!' : 'Item added but NOT saved to storage. Please export your data!' 
    });
    setTimeout(() => setNotification(null), 3000);
    clear();
  };

  const update = async () => {
    debug(`>>> UPDATE ITEM ${editingId} <<<`);
    
    if (!brand || !model) {
      setNotification({ type: 'error', message: 'Please fill in Brand and Model' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }
    
    const newItems = items.map(i => i.item_id === editingId ? {
      ...i,
      item_id: i.item_id,  // Explicitly preserve item ID
      category,
      brand,
      model,
      series,
      description,
      unit_price: price ? parseFloat(price) : null,
      image_url: imageUrl,
      image_data: uploadedImage || null,
      related_items: relatedItems ? relatedItems.split(',').map(s => s.trim()).filter(Boolean) : [],
      vendor_name: vendorName || '',
      vendor_quote_ref: vendorQuoteRef || '',
      vendor_link: vendorLink || ''
    } : i);
    
    setItems(newItems);
    const saved = await saveToStorage({ items: newItems });
    
    debug(`Updated: ${brand} ${model} ${saved ? '(saved)' : '(NOT SAVED)'}`);
    setNotification({ 
      type: 'success', 
      message: saved ? 'Item updated!' : 'Item updated but NOT saved to storage. Please export your data!' 
    });
    setTimeout(() => setNotification(null), 3000);
    clear();
  };

  const edit = (item) => {
    debug(`>>> EDIT: ${item.brand} ${item.model} <<<`);
    setBrand(item.brand);
    setModel(item.model);
    setCategory(item.category);
    setSeries(item.series || '');
    setDescription(item.description || '');
    setPrice(item.unit_price ? String(item.unit_price) : '');
    setImageUrl(item.image_url || '');
    setUploadedImage(item.image_data || null);
    setRelatedItems(item.related_items ? item.related_items.join(', ') : '');
    setVendorName(item.vendor_name || '');
    setVendorQuoteRef(item.vendor_quote_ref || '');
    setVendorLink(item.vendor_link || '');
    setEditingId(item.item_id);
    
    setTimeout(() => window.scrollTo({ top: 0, behavior: 'smooth' }), 100);
  };

  const del = (id) => {
    const item = items.find(i => i.item_id === id);
    if (!item) {
      debug('ERROR: Item not found');
      setNotification({ type: 'error', message: 'Item not found' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }
    debug(`Delete requested: ${item.brand} ${item.model}`);
    setDeleteConfirm({ id, item });
  };

  const confirmDelete = async () => {
    debug(`Confirming delete: ${deleteConfirm.id}`);
    const filtered = items.filter(i => i.item_id !== deleteConfirm.id);
    setItems(filtered);
    await saveToStorage({ items: filtered });
    debug(`‚úì Deleted. Remaining: ${filtered.length}`);
    setDeleteConfirm(null);
    setNotification({ type: 'success', message: 'Item deleted!' });
    setTimeout(() => setNotification(null), 3000);
  };

  const cancelDelete = () => {
    debug('Delete cancelled');
    setDeleteConfirm(null);
  };

  // Bulk edit functions
  const toggleBulkEdit = () => {
    setBulkEditMode(!bulkEditMode);
    setSelectedItems([]);
    setShowBulkEditPanel(false);
    debug(`Bulk edit mode: ${!bulkEditMode ? 'ON' : 'OFF'}`);
  };

  const toggleItemSelection = (itemId) => {
    setSelectedItems(prev => {
      if (prev.includes(itemId)) {
        return prev.filter(id => id !== itemId);
      } else {
        return [...prev, itemId];
      }
    });
  };

  const selectAllFiltered = () => {
    const filteredIds = filtered.map(i => i.item_id);
    setSelectedItems(filteredIds);
    debug(`Selected all ${filteredIds.length} filtered items`);
  };

  const deselectAll = () => {
    setSelectedItems([]);
    debug('Deselected all items');
  };

  // Calculate where a database item is used
  // Analyze export completeness
  const analyzeExportCompleteness = () => {
    const analysis = {
      totalBathrooms: bathrooms.length,
      configuredBathrooms: 0,
      missingSelections: [],
      incompleteOptions: []
    };

    bathrooms.forEach(bathroom => {
      if (!bathroom || !bathroom.options || bathroom.options.length === 0) {
        analysis.incompleteOptions.push({
          bathroom: bathroom?.name || 'Unknown',
          issue: 'No options available'
        });
        return;
      }

      const selectedOptionId = finalSelections[bathroom.id];
      
      if (!selectedOptionId) {
        analysis.incompleteOptions.push({
          bathroom: bathroom.name,
          issue: 'No option selected'
        });
        return;
      }

      analysis.configuredBathrooms++;
      
      const selectedOption = bathroom.options.find(o => o.id === selectedOptionId);
      if (selectedOption) {
        const features = bathroom.features || DEFAULT_FEATURES;
        features.forEach(feature => {
          if (feature.id === 'tiles') {
            // Check for wall tiles and floor tiles
            const hasWallTiles = Object.keys(selectedOption.selections || {}).some(k => k === 'wall_tiles');
            const hasFloorTiles = Object.keys(selectedOption.selections || {}).some(k => k === 'floor_tiles');
            
            if (!hasWallTiles) {
              analysis.missingSelections.push({
                bathroom: bathroom.name,
                option: selectedOption.name,
                zone: 'Wall Tiles',
                required: true
              });
            }
            if (!hasFloorTiles) {
              analysis.missingSelections.push({
                bathroom: bathroom.name,
                option: selectedOption.name,
                zone: 'Floor Tiles',
                required: true
              });
            }
          } else if (!selectedOption.selections || !selectedOption.selections[feature.id]) {
            analysis.missingSelections.push({
              bathroom: bathroom.name,
              option: selectedOption.name,
              zone: feature.name,
              required: feature.id === 'basin' || feature.id === 'wc'
            });
          }
        });
      }
    });

    return analysis;
  };

  const bulkUpdateCategory = async (newCategory) => {
    if (selectedItems.length === 0) {
      setNotification({ type: 'warning', message: 'No items selected' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }

    const count = selectedItems.length;
    const newItems = items.map(item => {
      if (selectedItems.includes(item.item_id)) {
        return { ...item, category: newCategory };
      }
      return item;
    });

    setItems(newItems);
    await saveToStorage({ items: newItems });
    debug(`‚úì Updated category to "${newCategory}" for ${count} items`);
    setNotification({ type: 'success', message: `Updated ${count} items to category: ${newCategory}` });
    setTimeout(() => setNotification(null), 3000);
    
    // Reset selections
    setSelectedItems([]);
    setShowBulkEditPanel(false);
  };

  const bulkUpdateBrand = async (newBrand) => {
    if (selectedItems.length === 0) {
      setNotification({ type: 'warning', message: 'No items selected' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }

    if (!newBrand.trim()) {
      setNotification({ type: 'warning', message: 'Please enter a brand name' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }

    const count = selectedItems.length;
    const newItems = items.map(item => {
      if (selectedItems.includes(item.item_id)) {
        return { ...item, brand: newBrand.trim() };
      }
      return item;
    });

    setItems(newItems);
    await saveToStorage({ items: newItems });
    debug(`‚úì Updated brand to "${newBrand}" for ${count} items`);
    setNotification({ type: 'success', message: `Updated ${count} items to brand: ${newBrand}` });
    setTimeout(() => setNotification(null), 3000);
    
    setSelectedItems([]);
    setShowBulkEditPanel(false);
  };

  const bulkUpdatePrice = async (adjustment, mode) => {
    if (selectedItems.length === 0) {
      setNotification({ type: 'warning', message: 'No items selected' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }

    const adjustmentValue = parseFloat(adjustment);
    if (isNaN(adjustmentValue)) {
      setNotification({ type: 'warning', message: 'Please enter a valid number' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }

    const count = selectedItems.length;
    const newItems = items.map(item => {
      if (selectedItems.includes(item.item_id)) {
        let newPrice = item.unit_price || 0;
        
        if (mode === 'add') {
          newPrice += adjustmentValue;
        } else if (mode === 'multiply') {
          newPrice *= adjustmentValue;
        } else if (mode === 'set') {
          newPrice = adjustmentValue;
        }
        
        return { ...item, unit_price: Math.max(0, newPrice) };
      }
      return item;
    });

    setItems(newItems);
    await saveToStorage({ items: newItems });
    debug(`‚úì Updated prices for ${count} items (${mode}: ${adjustmentValue})`);
    setNotification({ type: 'success', message: `Updated prices for ${count} items` });
    setTimeout(() => setNotification(null), 3000);
    
    setSelectedItems([]);
    setShowBulkEditPanel(false);
  };

  const bulkUpdateVendor = async (field, value) => {
    if (selectedItems.length === 0) {
      setNotification({ type: 'warning', message: 'No items selected' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }

    const count = selectedItems.length;
    const newItems = items.map(item => {
      if (selectedItems.includes(item.item_id)) {
        return { ...item, [field]: value.trim() };
      }
      return item;
    });

    setItems(newItems);
    await saveToStorage({ items: newItems });
    
    const fieldNames = {
      vendor_name: 'Vendor Name',
      vendor_quote_ref: 'Quote Reference',
      vendor_link: 'Vendor Contact'
    };
    
    debug(`‚úì Updated ${fieldNames[field]} for ${count} items`);
    setNotification({ type: 'success', message: `Updated ${fieldNames[field]} for ${count} items` });
    setTimeout(() => setNotification(null), 3000);
    
    setSelectedItems([]);
    setShowBulkEditPanel(false);
  };

  const bulkDelete = async () => {
    if (selectedItems.length === 0) {
      setNotification({ type: 'warning', message: 'No items selected' });
      setTimeout(() => setNotification(null), 3000);
      return;
    }

    const count = selectedItems.length;
    const confirmMsg = `Delete ${count} selected items? This cannot be undone.`;
    
    if (!window.confirm(confirmMsg)) {
      return;
    }

    const newItems = items.filter(item => !selectedItems.includes(item.item_id));
    setItems(newItems);
    await saveToStorage({ items: newItems });
    debug(`‚úì Deleted ${count} items. Remaining: ${newItems.length}`);
    setNotification({ type: 'success', message: `Deleted ${count} items successfully!` });
    setTimeout(() => setNotification(null), 3000);
    
    setSelectedItems([]);
    setBulkEditMode(false);
    setShowBulkEditPanel(false);
  };

  const exp = () => {
    try {
      debug('Exporting items...');
      const dataStr = JSON.stringify(items, null, 2);
      debug(`Export size: ${Math.round(dataStr.length / 1024)} KB`);
      
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const element = document.createElement('a');
      element.href = url;
      element.download = `bathroom-items-${new Date().toISOString().split('T')[0]}.json`;
      
      // Append to body, click, then remove
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
      
      // Clean up after a delay
      setTimeout(() => URL.revokeObjectURL(url), 100);
      
      debug(`‚úì Exported ${items.length} items to JSON`);
      setNotification({ type: 'success', message: `Exported ${items.length} items. Check your Downloads folder.` });
      setTimeout(() => setNotification(null), 4000);
    } catch (error) {
      debug(`‚ö†Ô∏è Export error: ${error.message}`);
      setNotification({ type: 'error', message: `Export failed: ${error.message}. See debug log for details.` });
      setTimeout(() => setNotification(null), 5000);
    }
  };

  const createBackup = () => {
    try {
      debug('Creating backup...');
      
      const backupData = {
        version: '2.0',
        timestamp: new Date().toISOString(),
        items: items,
        bathrooms: bathrooms,
        selections: finalSelections
      };
      
      debug(`Backup data: ${items.length} items, ${bathrooms.length} bathrooms`);
      
      // Use safe stringify
      const dataStr = safeStringify(backupData, true);
      
      debug(`Backup size: ${Math.round(dataStr.length / 1024)} KB`);
      
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const element = document.createElement('a');
      element.href = url;
      element.download = `bathroom-backup-${new Date().toISOString().split('T')[0]}.json`;
      
      // Append to body, click, then remove
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
      
      // Clean up after a delay
      setTimeout(() => URL.revokeObjectURL(url), 100);
      
      debug(`‚úì Backup created successfully`);
      setNotification({ type: 'success', message: 'Backup downloaded! Check your Downloads folder.' });
      setTimeout(() => setNotification(null), 4000);
      
    } catch (error) {
      debug(`‚ö†Ô∏è Backup error: ${error.message}`);
      debug(`Error stack: ${error.stack}`);
      setNotification({ type: 'error', message: `Backup failed: ${error.message}. Try exporting items separately from the Database tab.` });
      setTimeout(() => setNotification(null), 5000);
    }
  };

  const restoreBackup = async (backupData) => {
    try {
      if (backupData.version === '2.0') {
        // Normalize all items to ensure consistent schema (handles legacy field names)
        const newItems = (backupData.items || []).map(normalizeItem);
        
        // Normalize bathrooms to ensure renders array exists
        const newBathrooms = (backupData.bathrooms || []).map(bathroom => ({
          ...bathroom,
          renders: bathroom.renders || []
        }));
        
        const newSelections = backupData.selections || {};
        
        setItems(newItems);
        setBathrooms(newBathrooms);
        setFinalSelections(newSelections);
        
        await saveToStorage({
          items: newItems,
          bathrooms: newBathrooms,
          selections: newSelections
        });
        
        debug(`‚úì Restored and normalized: ${newItems.length} items, ${newBathrooms.length} bathrooms`);
        setNotification({ type: 'success', message: 'Backup restored successfully!' });
        setTimeout(() => setNotification(null), 3000);
      } else {
        setNotification({ type: 'error', message: 'Unsupported backup version' });
        setTimeout(() => setNotification(null), 3000);
      }
    } catch (error) {
      debug(`Restore error: ${error.message}`);
      setNotification({ type: 'error', message: 'Error restoring backup' });
      setTimeout(() => setNotification(null), 3000);
    }
  };

  const imp = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    debug(`Importing: ${file.name}`);
    const ext = file.name.split('.').pop().toLowerCase();

    if (ext === 'json') {
      const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          
          // Check if it's a backup file
          if (data.version === '2.0' && data.items) {
            await restoreBackup(data);
          } else if (Array.isArray(data)) {
            // Regular items array - normalize to ensure consistent schema
            const normalizedItems = data.map(normalizeItem);
            setItems(normalizedItems);
            await saveToStorage({ items: normalizedItems });
            debug(`‚úì Imported and normalized ${normalizedItems.length} items from JSON`);
            setNotification({ type: 'success', message: `Imported ${normalizedItems.length} items!` });
            setTimeout(() => setNotification(null), 3000);
          } else {
            throw new Error('Invalid JSON format');
          }
        } catch (err) {
          debug(`JSON import error: ${err.message}`);
          setNotification({ type: 'error', message: 'Invalid JSON file' });
          setTimeout(() => setNotification(null), 3000);
        }
      };
      reader.readAsText(file);
      
    } else if (ext === 'xlsx' || ext === 'xls') {
      try {
        debug('Loading XLSX library...');
        
        // Load XLSX library if not already loaded
        if (!window.XLSX) {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
          debug('‚úì XLSX library loaded');
        }
        
        const buffer = await file.arrayBuffer();
        const workbook = window.XLSX.read(buffer, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = window.XLSX.utils.sheet_to_json(worksheet);
        
        debug(`Excel rows: ${jsonData.length}`);
        
        const imported = jsonData.map((row, idx) => {
          const getValue = (possibleNames) => {
            for (const name of possibleNames) {
              const val = row[name];
              if (val !== undefined && val !== null && val !== '') {
                return String(val).trim();
              }
            }
            return '';
          };
          
          // Map category from Type column or Category column
          const categoryValue = getValue(['Category', 'category', 'Type', 'type']) || 'basin';
          const normalizedCategory = categoryValue.toLowerCase().replace(/\s+/g, '_');
          
          // Validate category
          const validCategory = cats.includes(normalizedCategory) ? normalizedCategory : 'basin';
          
          return {
            item_id: `item_${Date.now()}_${idx}`,
            category: validCategory,
            brand: getValue(['Brand', 'brand']) || 'Unknown',
            model: getValue(['Model', 'model']) || 'Unknown',
            series: getValue(['Series', 'series']),
            description: getValue(['Description', 'description']),
            type: getValue(['Type', 'type']),
            unit_price: parseFloat(getValue(['Price', 'price', 'Unit Price'])) || null,
            image_url: getValue(['Image', 'image', 'image_url', 'imageUrl', 'Image URL'])
          };
        });
        
        setItems(imported);
        await saveToStorage({ items: imported });
        debug(`‚úì Imported ${imported.length} items from Excel`);
        setNotification({ type: 'success', message: `Imported ${imported.length} items!` });
        setTimeout(() => setNotification(null), 3000);
        
      } catch (err) {
        debug(`Excel import error: ${err.message}`);
        setNotification({ type: 'error', message: 'Excel import failed. See debug log.' });
        setTimeout(() => setNotification(null), 3000);
      }
    }
    
    e.target.value = '';
  };

  const handleSort = async (column) => {
    const newDirection = sortConfig.column === column && sortConfig.direction === 'asc' ? 'desc' : 'asc';
    const newConfig = { column, direction: newDirection };
    setSortConfig(newConfig);
    
    // Save sort preference
    try {
      if (window.storage && typeof window.storage.set === 'function') {
        await window.storage.set('database-sort', JSON.stringify(newConfig));
      } else {
        localStorage.setItem('database-sort', JSON.stringify(newConfig));
      }
      debug(`‚úì Sort preference saved: ${column} (${newDirection})`);
    } catch (err) {
      debug(`‚ö†Ô∏è Failed to save sort preference: ${err.message}`);
    }
  };

  // Filter and sort items
  let filtered = filterCat === 'all' ? items : items.filter(i => i.category === filterCat);
  
  // Apply sorting if configured
  if (sortConfig.column) {
    filtered = [...filtered].sort((a, b) => {
      let aVal, bVal;
      
      if (sortConfig.column === 'category') {
        // Sort by user-facing category labels
        aVal = getCategoryLabel(a.category).toLowerCase();
        bVal = getCategoryLabel(b.category).toLowerCase();
      } else if (sortConfig.column === 'brand') {
        // Sort by brand (case-insensitive, trimmed)
        aVal = (a.brand || '').trim().toLowerCase();
        bVal = (b.brand || '').trim().toLowerCase();
      }
      
      if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });
  }

  const ConfigureBathrooms = () => {
    const getDefaultAccessories = () => [
      { name: 'Health Faucet Set', checked: false },
      { name: 'Shower Drain', checked: false },
      { name: 'Floor Drain near WC', checked: false },
      { name: 'Toilet Paper Holder', checked: false },
      { name: 'Hand Towel Rail', checked: false },
      { name: 'Towel Rack', checked: false },
      { name: 'Robe Hook', checked: false }
    ];

    const [bathroomName, setBathroomName] = React.useState('');
    const [importance, setImportance] = React.useState('medium');
    const [numOptions, setNumOptions] = React.useState(3);

    const addBathroom = async () => {
      if (!bathroomName) {
        setNotification({ type: 'warning', message: 'Enter bathroom name' });
        setTimeout(() => setNotification(null), 3000);
        return;
      }
      
      const options = [];
      for (let i = 0; i < numOptions; i++) {
        options.push({
          id: `option_${String.fromCharCode(97 + i)}`,
          name: `Option ${String.fromCharCode(65 + i)}`,
          selections: {},
          accessories: getDefaultAccessories()
        });
      }

      const newBathroom = {
        id: `bathroom_${Date.now()}`,
        name: bathroomName,
        importance,
        options,
        renders: [] // Store render images
      };

      const newBathrooms = [...bathrooms, newBathroom];
      setBathrooms(newBathrooms);
      await saveToStorage({ bathrooms: newBathrooms });
      
      debug(`‚úì Bathroom added: ${bathroomName} with ${numOptions} options`);
      setNotification({ type: 'success', message: 'Bathroom added!' });
      setTimeout(() => setNotification(null), 3000);
      setBathroomName('');
    };

    const deleteBathroom = async (id) => {
      if (window.confirm('Delete this bathroom? This cannot be undone.')) {
        const newBathrooms = bathrooms.filter(b => b.id !== id);
        setBathrooms(newBathrooms);
        await saveToStorage({ bathrooms: newBathrooms });
        debug('‚úì Bathroom deleted');
      }
    };

    return (
      <div className="max-w-6xl mx-auto p-6">
        <div className="mb-6">
          <h2 className="text-3xl font-bold text-gray-900">Manage Bathrooms</h2>
          <p className="text-gray-600 mt-2">
            Create bathrooms and define how many options you want to compare for each one
          </p>
        </div>

        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-md p-6 mb-6 border border-blue-200">
          <h3 className="text-xl font-bold mb-4 text-blue-900">‚ûï Add New Bathroom</h3>
          <div className="grid grid-cols-2 gap-4">
            <input
              value={bathroomName}
              onChange={(e) => setBathroomName(e.target.value)}
              placeholder="Bathroom Name *"
              className="border rounded px-3 py-2"
            />
            <select
              value={importance}
              onChange={(e) => setImportance(e.target.value)}
              className="border rounded px-3 py-2"
            >
              <option value="low">Low Importance</option>
              <option value="medium">Medium Importance</option>
              <option value="high">High Importance</option>
            </select>
            
            <div>
              <label className="block font-semibold mb-2">Number of Options to Compare:</label>
              <input
                type="number"
                min="1"
                max="5"
                value={numOptions}
                onChange={(e) => setNumOptions(parseInt(e.target.value) || 1)}
                className="border rounded px-3 py-2 w-full"
              />
              <p className="text-xs text-gray-600 mt-1">
                Create multiple options (A, B, C...) to compare different product selections
              </p>
            </div>
            
            <button
              onClick={addBathroom}
              className="col-span-2 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 text-lg"
            >
              ‚ûï Add Bathroom
            </button>
          </div>
        </div>

        {/* Existing Bathrooms List */}
        {bathrooms.length > 0 && (
          <div className="mb-4">
            <h3 className="text-xl font-bold text-gray-900">Your Bathrooms ({bathrooms.length})</h3>
            <p className="text-sm text-gray-600">Click Configure to select products or Edit to change details</p>
          </div>
        )}

        <div className="space-y-4">
          {bathrooms.length === 0 ? (
            <div className="bg-gray-50 border border-gray-200 rounded p-6 text-center text-gray-600">
              No bathrooms configured yet. Add your first bathroom above.
            </div>
          ) : (
            bathrooms.map(bathroom => {
              const [isEditing, setIsEditing] = React.useState(false);
              const [editName, setEditName] = React.useState(bathroom.name);
              const [editImportance, setEditImportance] = React.useState(bathroom.importance);

              const handleRenderUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                const renderPromises = files.map(file => {
                  return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                      resolve({
                        id: `render_${Date.now()}_${Math.random()}`,
                        data: event.target.result,
                        name: file.name
                      });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                  });
                });

                try {
                  const newRenders = await Promise.all(renderPromises);
                  const updatedBathrooms = bathrooms.map(b =>
                    b.id === bathroom.id
                      ? { ...b, renders: [...(b.renders || []), ...newRenders] }
                      : b
                  );
                  setBathrooms(updatedBathrooms);
                  await saveToStorage({ bathrooms: updatedBathrooms });
                  debug(`Added ${newRenders.length} render(s) to ${bathroom.name}`);
                  setNotification({ type: 'success', message: `${newRenders.length} render image(s) uploaded!` });
                  setTimeout(() => setNotification(null), 3000);
                } catch (error) {
                  debug(`Render upload error: ${error.message}`);
                  setNotification({ type: 'error', message: 'Error uploading renders' });
                  setTimeout(() => setNotification(null), 3000);
                }
              };

              const deleteRender = async (renderId) => {
                if (window.confirm('Delete this render?')) {
                  const updatedBathrooms = bathrooms.map(b =>
                    b.id === bathroom.id
                      ? { ...b, renders: (b.renders || []).filter(r => r.id !== renderId) }
                      : b
                  );
                  setBathrooms(updatedBathrooms);
                  await saveToStorage({ bathrooms: updatedBathrooms });
                  debug(`Deleted render from ${bathroom.name}`);
                }
              };

              return (
                <div key={bathroom.id} className="bg-white rounded shadow p-4">
                  {isEditing ? (
                    <div className="space-y-3">
                      <input
                        type="text"
                        value={editName}
                        onChange={(e) => setEditName(e.target.value)}
                        className="w-full border rounded px-3 py-2 font-bold"
                        placeholder="Bathroom Name"
                      />
                      <select
                        value={editImportance}
                        onChange={(e) => setEditImportance(e.target.value)}
                        className="w-full border rounded px-3 py-2"
                      >
                        <option value="low">Low Importance</option>
                        <option value="medium">Medium Importance</option>
                        <option value="high">High Importance</option>
                      </select>
                      <div className="flex gap-2">
                        <button
                          onClick={async () => {
                            if (!editName.trim()) {
                              setNotification({ type: 'warning', message: 'Bathroom name cannot be empty' });
                              setTimeout(() => setNotification(null), 3000);
                              return;
                            }
                            const updatedBathrooms = bathrooms.map(b =>
                              b.id === bathroom.id
                                ? { ...b, name: editName, importance: editImportance }
                                : b
                            );
                            setBathrooms(updatedBathrooms);
                            await saveToStorage({ bathrooms: updatedBathrooms });
                            setIsEditing(false);
                            debug(`Updated bathroom: ${editName}`);
                          }}
                          className="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                        >
                          Save
                        </button>
                        <button
                          onClick={() => {
                            setEditName(bathroom.name);
                            setEditImportance(bathroom.importance);
                            setIsEditing(false);
                          }}
                          className="flex-1 px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <h4 className="font-bold text-lg">{bathroom.name}</h4>
                        <p className="text-sm text-gray-600">
                          Importance: {bathroom.importance} | {bathroom.options.length} options
                        </p>
                        
                        {/* Renders Preview */}
                        {bathroom.renders && bathroom.renders.length > 0 && (
                          <div className="mt-3">
                            <p className="text-xs text-gray-500 mb-2">Renders ({bathroom.renders.length})</p>
                            <div className="flex gap-2 flex-wrap">
                              {bathroom.renders.map(render => (
                                <div key={render.id} className="relative group">
                                  <img
                                    src={render.data}
                                    alt={render.name}
                                    className="w-20 h-20 object-cover rounded border"
                                  />
                                  <button
                                    onClick={() => deleteRender(render.id)}
                                    className="absolute -top-1 -right-1 bg-red-600 text-white rounded-full w-5 h-5 text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                      <div className="flex gap-2">
                        <label className="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 cursor-pointer text-sm">
                          üì∑ Renders
                          <input
                            type="file"
                            accept="image/*"
                            multiple
                            onChange={handleRenderUpload}
                            className="hidden"
                          />
                        </label>
                        <button
                          onClick={() => setIsEditing(true)}
                          className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                        >
                          ‚úèÔ∏è Edit
                        </button>
                        <button
                          onClick={() => {
                            setSelectedBathroom(bathroom);
                            setView('compare');
                          }}
                          className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                        >
                          Configure ‚Üí
                        </button>
                        <button
                          onClick={() => deleteBathroom(bathroom.id)}
                          className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              );
            })
          )}
        </div>
      </div>
    );
  };

  const CompareOptions = () => {
    // If no bathroom selected but bathrooms exist, show selector
    if (!selectedBathroom && bathrooms.length > 0) {
      return (
        <div className="max-w-6xl mx-auto p-6">
          <h2 className="text-2xl font-bold mb-4">Configure Options</h2>
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <p className="text-blue-800 mb-4">Select a bathroom to configure:</p>
            <select
              onChange={(e) => {
                const bathroom = bathrooms.find(b => b.id === e.target.value);
                if (bathroom) {
                  setSelectedBathroom(bathroom);
                }
              }}
              className="w-full border rounded px-4 py-3 text-lg"
              defaultValue=""
            >
              <option value="">-- Select Bathroom --</option>
              {bathrooms.map(bathroom => (
                <option key={bathroom.id} value={bathroom.id}>
                  {bathroom.name} ({bathroom.options.length} options)
                </option>
              ))}
            </select>
          </div>
        </div>
      );
    }

    if (!selectedBathroom) {
      return (
        <div className="max-w-6xl mx-auto p-6">
          <h2 className="text-2xl font-bold mb-4">Configure Options</h2>
          <p className="text-gray-600">No bathrooms configured yet.</p>
          <button
            onClick={() => {
                  setView('configure');
                  if (typeof window !== 'undefined' && window.sc_log_pv) {
                    try { window.sc_log_pv(); } catch(e) {}
                  }
                }}
            className="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            Go to Bathrooms Tab
          </button>
        </div>
      );
    }

    const updateBathroom = async (updated) => {
      const newBathrooms = bathrooms.map(b => b.id === updated.id ? updated : b);
      setBathrooms(newBathrooms);
      await saveToStorage({ bathrooms: newBathrooms });
      setSelectedBathroom(updated);
    };

    const defaultCategories = [
      // Basin Zone
      { key: 'basin', label: 'Basin', zone: 'basin', order: 1, types: ['basin', 'Basin'] },
      { key: 'mixer', label: 'Basin Mixer', zone: 'basin', order: 2, types: ['mixer', 'Mixer', 'basin mixer', 'Basin Mixer'] },
      { key: 'concealed_body', label: 'Concealed Body', zone: 'basin', order: 3, auto: true, types: ['concealed_body', 'Concealed Body', 'concealed body'] },
      
      // WC Zone
      { key: 'wc', label: 'WC', zone: 'wc', order: 1, types: ['wc', 'WC', 'water closet', 'Water Closet'] },
      { key: 'health_faucet', label: 'Health Faucet', zone: 'wc', order: 2, optional: true, types: ['health_faucet', 'Health Faucet', 'health faucet'] },
      
      // Shower Zone
      { key: 'hand_shower', label: 'Hand Shower', zone: 'shower', order: 1, types: ['hand_shower', 'Hand Shower', 'hand shower', 'handshower'] },
      { key: 'hand_shower_hose', label: 'Hand Shower Hose', zone: 'shower', order: 2, auto: true, types: ['hand_shower_hose', 'Hand Shower Hose', 'hand shower hose', 'hose', 'Hose', 'shower hose', 'Shower Hose'] },
      { key: 'hand_shower_outlet', label: 'Hand Shower Wall Outlet', zone: 'shower', order: 3, auto: true, types: ['hand_shower_outlet', 'Hand Shower Outlet', 'hand shower outlet', 'wall outlet', 'Wall Outlet', 'shower outlet', 'Shower Outlet'] },
      { key: 'hand_shower_rail', label: 'Hand Shower Rail', zone: 'shower', order: 4, optional: true, types: ['hand_shower_rail', 'Hand Shower Rail', 'hand shower rail', 'rail', 'Rail', 'shower rail', 'Shower Rail'] },
      { key: 'overhead_shower', label: 'Overhead Shower', zone: 'shower', order: 5, types: ['overhead_shower', 'Overhead Shower', 'overhead shower', 'rain shower', 'Rain Shower'] },
      { key: 'shower_arm', label: 'Shower Arm', zone: 'shower', order: 6, auto: true, types: ['shower_arm', 'Shower Arm', 'shower arm', 'arm'] },
      { key: 'diverter', label: 'Diverter', zone: 'shower', order: 7, types: ['diverter', 'Diverter'] },
      { key: 'diverter_concealed_body', label: 'Diverter Concealed Body', zone: 'shower', order: 8, auto: true, types: ['diverter_concealed_body', 'Diverter Concealed Body', 'diverter concealed body'] },
      { key: 'shower_panel', label: 'Shower Panel', zone: 'shower', order: 9, types: ['shower_panel', 'Shower Panel', 'shower panel', 'panel'] },
      { key: 'geyser', label: 'Geyser', zone: 'shower', order: 10, optional: true, types: ['geyser', 'Geyser', 'water heater', 'Water Heater'] },
      
      // Accessories Zone
      { key: 'shower_drain', label: 'Shower Drain', zone: 'accessories', order: 1, optional: true, types: ['shower_drain', 'Shower Drain'] },
      { key: 'floor_drain_wc', label: 'Floor Drain near WC', zone: 'accessories', order: 2, optional: true, types: ['floor_drain_wc', 'Floor Drain near WC', 'floor drain'] },
      { key: 'toilet_paper_holder', label: 'Toilet Paper Holder', zone: 'accessories', order: 3, optional: true, types: ['toilet_paper_holder', 'Toilet Paper Holder'] },
      { key: 'hand_towel_rail', label: 'Hand Towel Rail', zone: 'accessories', order: 4, optional: true, types: ['hand_towel_rail', 'Hand Towel Rail'] },
      { key: 'towel_rack', label: 'Towel Rack', zone: 'accessories', order: 5, optional: true, types: ['towel_rack', 'Towel Rack'] },
      { key: 'robe_hook', label: 'Robe Hook', zone: 'accessories', order: 6, optional: true, types: ['robe_hook', 'Robe Hook'] },
      { key: 'drain', label: 'Drain', zone: 'accessories', order: 7, optional: true, types: ['drain', 'Drain'] },
      
      // Tiles Zone
      { key: 'wall_tiles', label: 'Wall Tiles', zone: 'tiles', order: 1, types: ['wall_tiles', 'Wall Tiles', 'wall tiles'] },
      { key: 'feature_wall_tiles', label: 'Feature Wall Tiles', zone: 'tiles', order: 2, optional: true, types: ['feature_wall_tiles', 'Feature Wall Tiles', 'feature wall tiles'] },
      { key: 'floor_tiles', label: 'Floor Tiles', zone: 'tiles', order: 3, types: ['floor_tiles', 'Floor Tiles', 'floor tiles'] }
    ];

    // Add custom categories to the categories array
    const customCats = customCategories.map((cat, index) => {
      const catName = typeof cat === 'string' ? cat : cat.name;
      const catZone = typeof cat === 'string' ? 'general' : (cat.zone || 'general');
      
      return {
        key: catName.toLowerCase().replace(/\s+/g, '_'),
        label: catName,
        zone: catZone,
        order: 100 + index, // Place custom categories after default ones
        optional: true,
        types: [catName, catName.toLowerCase()],
        isCustom: true
      };
    });

    const categories = [...defaultCategories, ...customCats];

    const zoneLabels = {
      'basin': 'üö∞ BASIN ZONE',
      'wc': 'üöΩ WC ZONE',
      'shower': 'üöø SHOWER ZONE',
      'accessories': 'üîß ACCESSORIES ZONE',
      'tiles': 'üèóÔ∏è TILES ZONE',
      'lighting': 'üí° LIGHTING ZONE',
      'general': 'üì¶ GENERAL'
    };

    // Group categories by zone
    const categoriesByZone = categories.reduce((acc, cat) => {
      if (!acc[cat.zone]) acc[cat.zone] = [];
      acc[cat.zone].push(cat);
      return acc;
    }, {});

    // Sort by order within each zone
    Object.keys(categoriesByZone).forEach(zone => {
      categoriesByZone[zone].sort((a, b) => a.order - b.order);
    });

    // Helper function to match items to categories
    const getItemsForCategory = (categoryKey) => {
      const cat = categories.find(c => c.key === categoryKey);
      if (!cat) return [];
      
      return items.filter(item => {
        // First try exact category match
        if (item.category === categoryKey) return true;
        
        // Then try type field match (from Excel)
        if (item.type) {
          const normalizedType = item.type.toLowerCase().trim();
          const normalizedKey = categoryKey.toLowerCase().replace(/_/g, ' ');
          
          // Check if type matches any of the allowed types (EXACT match only)
          if (cat.types) {
            const matches = cat.types.some(t => {
              const normalizedAllowedType = t.toLowerCase().trim();
              // Use exact match only - no substring matching
              return normalizedType === normalizedAllowedType;
            });
            if (matches) return true;
          }
          
          // Fallback: check if type exactly matches category key
          if (normalizedType === normalizedKey || 
              normalizedType.replace(/\s+/g, '_') === categoryKey) {
            return true;
          }
        }
        
        return false;
      });
    };

    const updateSelection = (optionId, category, itemId) => {
      const item = items.find(i => i.item_id === itemId);
      const updatedOptions = selectedBathroom.options.map(opt => {
        if (opt.id === optionId) {
          const newSelections = { ...opt.selections };
          
          if (itemId && item) {
            newSelections[category] = item;
            debug(`Selected ${category}: ${item.brand} ${item.model}`);
            
            // Auto-select concealed body with mixer
            if (category === 'mixer') {
              const concealedBodies = getItemsForCategory('concealed_body');
              if (concealedBodies.length > 0) {
                const matchingBody = concealedBodies.find(cb => cb.brand === item.brand) || concealedBodies[0];
                newSelections['concealed_body'] = matchingBody;
                debug(`Auto-selected concealed body: ${matchingBody.brand} ${matchingBody.model}`);
              }
            }
            
            // Auto-select hose and wall outlet with hand shower
            if (category === 'hand_shower') {
              // Select hand shower hose
              const hoses = getItemsForCategory('hand_shower_hose');
              if (hoses.length > 0) {
                const matchingHose = hoses.find(h => h.brand === item.brand) || hoses[0];
                newSelections['hand_shower_hose'] = matchingHose;
                debug(`Auto-selected hand shower hose: ${matchingHose.brand} ${matchingHose.model}`);
              }
              
              // Select hand shower wall outlet
              const outlets = getItemsForCategory('hand_shower_outlet');
              if (outlets.length > 0) {
                const matchingOutlet = outlets.find(o => o.brand === item.brand) || outlets[0];
                newSelections['hand_shower_outlet'] = matchingOutlet;
                debug(`Auto-selected hand shower wall outlet: ${matchingOutlet.brand} ${matchingOutlet.model}`);
              }
            }
            
            // Auto-select shower arm with overhead shower
            if (category === 'overhead_shower') {
              const showerArms = getItemsForCategory('shower_arm');
              if (showerArms.length > 0) {
                const matchingArm = showerArms.find(sa => sa.brand === item.brand) || showerArms[0];
                newSelections['shower_arm'] = matchingArm;
                debug(`Auto-selected shower arm: ${matchingArm.brand} ${matchingArm.model}`);
              }
            }
            
            // Shower panel exclusivity
            if (category === 'shower_panel') {
              delete newSelections.hand_shower;
              delete newSelections.hand_shower_hose;
              delete newSelections.hand_shower_outlet;
              delete newSelections.hand_shower_rail;
              delete newSelections.overhead_shower;
              delete newSelections.diverter;
              delete newSelections.shower_arm;
              debug('Shower panel selected - removed conflicting items');
            }
            
            // Generic related items auto-selection (database-defined relationships)
            if (item.related_items && item.related_items.length > 0) {
              debug(`Item has ${item.related_items.length} related items: ${item.related_items.join(', ')}`);
              
              item.related_items.forEach(relatedModel => {
                // Find the related item by model number
                const relatedItem = items.find(i => 
                  i.model.toLowerCase().trim() === relatedModel.toLowerCase().trim()
                );
                
                if (relatedItem) {
                  // Determine which category this related item belongs to
                  const relatedCategory = relatedItem.category;
                  
                  if (relatedCategory) {
                    newSelections[relatedCategory] = relatedItem;
                    debug(`Auto-selected related item: ${relatedItem.category} - ${relatedItem.brand} ${relatedItem.model}`);
                  }
                } else {
                  debug(`‚ö†Ô∏è Related item not found in database: ${relatedModel}`);
                }
              });
            }
            
          } else {
            // Item deselected
            delete newSelections[category];
            
            // Remove dependent items
            if (category === 'mixer') {
              delete newSelections['concealed_body'];
              debug('Mixer removed - removed concealed body');
            }
            if (category === 'hand_shower') {
              delete newSelections['hand_shower_hose'];
              delete newSelections['hand_shower_outlet'];
              delete newSelections['hand_shower_rail'];
              debug('Hand shower removed - removed hose, wall outlet, and rail');
            }
            if (category === 'overhead_shower') {
              delete newSelections['shower_arm'];
              debug('Overhead shower removed - removed shower arm');
            }
          }
          
          return { ...opt, selections: newSelections };
        }
        return opt;
      });
      
      updateBathroom({ ...selectedBathroom, options: updatedOptions });
    };

    const toggleAccessory = (optionId, accIdx) => {
      const updatedOptions = selectedBathroom.options.map(opt => {
        if (opt.id === optionId) {
          const newAcc = [...opt.accessories];
          newAcc[accIdx] = { ...newAcc[accIdx], checked: !newAcc[accIdx].checked };
          return { ...opt, accessories: newAcc };
        }
        return opt;
      });
      updateBathroom({ ...selectedBathroom, options: updatedOptions });
    };

    const calculateTotal = (option) => {
      let total = 0;
      Object.values(option.selections).forEach(item => {
        const price = item?.unit_price ?? item?.price;
        if (price) total += price;
      });
      return total;
    };

    const baseTotal = selectedBathroom.options.length > 0 ? calculateTotal(selectedBathroom.options[0]) : 0;

    return (
      <div className="max-w-full mx-auto p-6">
        <div className="flex justify-between items-center mb-6">
          <div className="flex items-center gap-4">
            <h2 className="text-2xl font-bold">{selectedBathroom.name} - Configure Options</h2>
            <select
              value={selectedBathroom.id}
              onChange={(e) => {
                const bathroom = bathrooms.find(b => b.id === e.target.value);
                if (bathroom) {
                  setSelectedBathroom(bathroom);
                }
              }}
              className="border rounded px-3 py-2 text-sm bg-white"
            >
              {bathrooms.map(bathroom => (
                <option key={bathroom.id} value={bathroom.id}>
                  Switch to: {bathroom.name}
                </option>
              ))}
            </select>
          </div>
          <div className="flex items-center gap-3">
            <button
              onClick={() => {
                const newOptionId = `option_${String.fromCharCode(97 + selectedBathroom.options.length)}`;
                const newOptionName = `Option ${String.fromCharCode(65 + selectedBathroom.options.length)}`;
                const newOption = {
                  id: newOptionId,
                  name: newOptionName,
                  selections: {},
                  accessories: [
                    { name: 'Health Faucet Set', checked: false },
                    { name: 'Shower Drain', checked: false },
                    { name: 'Floor Drain near WC', checked: false },
                    { name: 'Toilet Paper Holder', checked: false },
                    { name: 'Hand Towel Rail', checked: false },
                    { name: 'Towel Rack', checked: false },
                    { name: 'Robe Hook', checked: false }
                  ]
                };
                
                const updatedBathroom = {
                  ...selectedBathroom,
                  options: [...selectedBathroom.options, newOption]
                };
                
                updateBathroom(updatedBathroom);
                setNotification({ type: 'success', message: `${newOptionName} added!` });
                setTimeout(() => setNotification(null), 3000);
                debug(`Added new ${newOptionName}`);
              }}
              className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold"
              title="Add a new option"
            >
              + Add Option
            </button>
            <div className="text-sm text-gray-600">
              <span className="font-semibold">{selectedBathroom.options.length}</span> options | 
              <span className="font-semibold ml-1">{items.length}</span> items
            </div>
          </div>
        </div>

        {items.length === 0 && (
          <div className="bg-red-50 border border-red-200 rounded p-4 mb-6">
            <p className="text-red-800 font-bold">‚ö†Ô∏è No items in database!</p>
            <p className="text-sm text-red-700">
              Go to Database tab and import your product data first.
            </p>
          </div>
        )}

        <div
          className="grid gap-6"
          style={{ gridTemplateColumns: `repeat(${selectedBathroom.options.length}, minmax(320px, 1fr))` }}
        >
          {selectedBathroom.options.map(option => {
            const total = calculateTotal(option);
            const delta = total - baseTotal;

            return (
              <div key={option.id} className="bg-white rounded shadow p-4">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-xl font-bold">{option.name}</h3>
                  <div className="flex gap-2">
                    <button
                      onClick={async () => {
                        const newOptionId = `option_${String.fromCharCode(97 + selectedBathroom.options.length)}`;
                        const newOptionName = `Option ${String.fromCharCode(65 + selectedBathroom.options.length)}`;
                        const duplicatedOption = {
                          id: newOptionId,
                          name: newOptionName,
                          selections: { ...option.selections },
                          accessories: option.accessories.map(acc => ({ ...acc }))
                        };
                        
                        const updatedBathroom = {
                          ...selectedBathroom,
                          options: [...selectedBathroom.options, duplicatedOption]
                        };
                        
                        await updateBathroom(updatedBathroom);
                        setNotification({ type: 'success', message: `Created ${newOptionName} as copy of ${option.name}` });
                        setTimeout(() => setNotification(null), 3000);
                        debug(`Duplicated ${option.name} to ${newOptionName}`);
                      }}
                      className="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700"
                      title="Duplicate this option"
                    >
                      üìã Duplicate
                    </button>
                    {selectedBathroom.options.length > 1 && (
                      <>
                        {deleteConfirmOption === option.id ? (
                          <div className="flex gap-1 items-center bg-red-50 px-2 py-1 rounded border border-red-300">
                            <span className="text-xs text-red-700 font-semibold">Delete?</span>
                            <button
                              onClick={async (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                try {
                                  console.log('Confirming delete for:', option.name);
                                  
                                  const filteredOptions = selectedBathroom.options.filter(opt => opt.id !== option.id);
                                  
                                  // Renumber remaining options to maintain A, B, C sequence
                                  const renumberedOptions = filteredOptions.map((opt, index) => ({
                                    ...opt,
                                    id: `option_${String.fromCharCode(97 + index)}`,
                                    name: `Option ${String.fromCharCode(65 + index)}`
                                  }));
                                  
                                  const updatedBathroom = {
                                    ...selectedBathroom,
                                    options: renumberedOptions
                                  };
                                  
                                  const newBathrooms = bathrooms.map(b => 
                                    b.id === selectedBathroom.id ? updatedBathroom : b
                                  );
                                  
                                  setBathrooms(newBathrooms);
                                  setSelectedBathroom(updatedBathroom);
                                  await saveToStorage({ bathrooms: newBathrooms });
                                  
                                  setDeleteConfirmOption(null);
                                  setNotification({ type: 'success', message: `${option.name} deleted successfully!` });
                                  setTimeout(() => setNotification(null), 3000);
                                  debug(`‚úì Deleted ${option.name}, renumbered remaining options`);
                                  console.log('Delete successful! Options renumbered.');
                                } catch (error) {
                                  console.error('Delete error:', error);
                                  debug(`‚ö†Ô∏è Error deleting option: ${error.message}`);
                                  setDeleteConfirmOption(null);
                                }
                              }}
                              className="px-2 py-0.5 bg-red-600 text-white text-xs rounded hover:bg-red-700"
                            >
                              Yes
                            </button>
                            <button
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                setDeleteConfirmOption(null);
                                console.log('Delete cancelled');
                              }}
                              className="px-2 py-0.5 bg-gray-400 text-white text-xs rounded hover:bg-gray-500"
                            >
                              No
                            </button>
                          </div>
                        ) : (
                          <button
                            onClick={(e) => {
                              e.preventDefault();
                              e.stopPropagation();
                              console.log('Delete button clicked for:', option.name);
                              setDeleteConfirmOption(option.id);
                            }}
                            className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700"
                            title="Delete this option"
                          >
                            üóëÔ∏è Delete
                          </button>
                        )}
                      </>
                    )}
                  </div>
                </div>

                <div className="space-y-6 mb-6">
                  {/* Render categories grouped by zone */}
                  {Object.entries(categoriesByZone).map(([zone, zoneCats]) => (
                    <div key={zone} className="bg-gray-50 rounded-lg p-4">
                      <h4 className="text-md font-bold text-gray-700 mb-3 pb-2 border-b-2 border-gray-300">
                        {zoneLabels[zone]}
                      </h4>
                      
                      <div className="space-y-3">
                        {zoneCats.map(({ key, label, auto, optional }) => {
                          const categoryItems = getItemsForCategory(key);
                          const selected = option.selections[key];
                          
                          // Check if this is hand shower rail and if hand shower is selected
                          const isHandShowerRail = key === 'hand_shower_rail';
                          const hasHandShower = option.selections['hand_shower'];
                          const showHandShowerRail = isHandShowerRail && hasHandShower;
                          
                          // Skip hand shower rail if hand shower is not selected
                          if (isHandShowerRail && !hasHandShower) {
                            return null;
                          }
                          
                          // Check if this is an optional item
                          const isOptional = optional;

                          return (
                            <div key={key} className="border-b border-gray-200 pb-3 last:border-0">
                              {/* Optional checkbox */}
                              {isOptional && (
                                <label className="flex items-center gap-2 mb-2">
                                  <input
                                    type="checkbox"
                                    checked={!!selected}
                                    onChange={(e) => {
                                      e.stopPropagation();
                                      const isChecked = e.target.checked;
                                      
                                      if (isChecked) {
                                        // Auto-select first available item (already computed)
                                        if (categoryItems.length > 0) {
                                          updateSelection(option.id, key, categoryItems[0].item_id);
                                        }
                                      } else {
                                        // Deselect item
                                        updateSelection(option.id, key, '');
                                      }
                                    }}
                                  />
                                  <span className="font-semibold text-sm">Include {label}?</span>
                                </label>
                              )}
                              
                              {/* Show dropdown only if not optional OR checkbox is checked */}
                              {(!isOptional || selected) && (
                                <>
                                  <label className="block font-semibold text-sm mb-2">
                                    {label}
                                    {categoryItems.length > 0 && ` (${categoryItems.length})`}
                                    {auto && selected && (
                                      <span className="text-blue-600 text-xs ml-2">‚úì Auto-selected</span>
                                    )}
                                  </label>
                                  <select
                                    value={selected?.item_id || ''}
                                    onChange={(e) => updateSelection(option.id, key, e.target.value)}
                                    className="w-full border rounded px-2 py-1 text-sm mb-2"
                                  >
                                    <option value="">-- Select {label} --</option>
                                    {categoryItems.map(item => (
                                      <option key={item.item_id} value={item.item_id}>
                                        {item.brand} - {item.model}
                                        {(item.unit_price ?? item.price) ? ` (‚Çπ${(item.unit_price ?? item.price)})` : ''}
                                      </option>
                                    ))}
                                  </select>
                                </>
                              )}
                              
                              {selected && (
                                <div className="bg-white p-2 rounded border">
                                  <div className="flex justify-between items-start mb-2">
                                    <div className="flex-1">
                                      {(selected.image_data || selected.image_url) && (
                                        <img
                                          src={selected.image_data || selected.image_url}
                                          alt={selected.model}
                                          className="w-full h-32 object-cover rounded mb-1"
                                          onError={(e) => {
                                            e.target.style.display = 'none';
                                          }}
                                        />
                                      )}
                                      {selected.description && (
                                        <p className="text-xs text-gray-700">{selected.description}</p>
                                      )}
                                      {(selected.unit_price ?? selected.price) && (
                                        <p className="text-sm font-semibold mt-1">{currency}{(selected.unit_price ?? selected.price).toFixed(2)}</p>
                                      )}
                                    </div>
                                    {!auto && (
                                      <button
                                        onClick={() => updateSelection(option.id, key, '')}
                                        className="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600"
                                        title="Remove this item"
                                      >
                                        ‚úï
                                      </button>
                                    )}
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>

                <div className="bg-blue-50 p-4 rounded mb-4">
                  <div className="text-lg font-bold">Total: {currency}{total.toFixed(2)}</div>
                  {option.id !== selectedBathroom.options[0].id && (
                    <div className={`text-sm ${delta >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                      {delta >= 0 ? '+' : ''}{currency}{delta.toFixed(2)} vs {selectedBathroom.options[0].name}
                    </div>
                  )}
                </div>

                <button
                  onClick={async () => {
                    const newSelections = { ...finalSelections, [selectedBathroom.id]: option.id };
                    setFinalSelections(newSelections);
                    await saveToStorage({ selections: newSelections });
                    setNotification({ type: 'success', message: `${option.name} selected for ${selectedBathroom.name}!` });
                    setTimeout(() => setNotification(null), 3000);
                  }}
                  className={`w-full py-2 rounded font-semibold ${
                    finalSelections[selectedBathroom.id] === option.id
                      ? 'bg-green-600 text-white'
                      : 'bg-gray-200 hover:bg-gray-300'
                  }`}
                >
                  {finalSelections[selectedBathroom.id] === option.id ? '‚úì Selected' : 'Select This Option'}
                </button>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  const OptionSummary = () => {
    // If no bathroom selected but bathrooms exist, show selector
    if (!selectedBathroom && bathrooms.length > 0) {
      return (
        <div className="max-w-6xl mx-auto p-6">
          <h2 className="text-2xl font-bold mb-4">Option Summary</h2>
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <p className="text-blue-800 mb-4">Select a bathroom to view options:</p>
            <select
              onChange={(e) => {
                const bathroom = bathrooms.find(b => b.id === e.target.value);
                if (bathroom) {
                  setSelectedBathroom(bathroom);
                }
              }}
              className="w-full border rounded px-4 py-3 text-lg"
              defaultValue=""
            >
              <option value="">-- Select Bathroom --</option>
              {bathrooms.map(bathroom => (
                <option key={bathroom.id} value={bathroom.id}>
                  {bathroom.name}
                </option>
              ))}
            </select>
          </div>
        </div>
      );
    }

    if (!selectedBathroom) {
      return (
        <div className="max-w-6xl mx-auto p-6">
          <h2 className="text-2xl font-bold mb-4">Option Summary</h2>
          <p className="text-gray-600">No bathrooms configured yet.</p>
          <button
            onClick={() => setView('configure')}
            className="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            Go to Bathrooms Tab
          </button>
        </div>
      );
    }

    const calculateTotal = (option) => {
      let total = 0;
      Object.values(option.selections).forEach(item => {
        const price = item?.unit_price ?? item?.price;
        if (price) total += price;
      });
      return total;
    };

    return (
      <div className="max-w-7xl mx-auto p-6">
        <div className="flex justify-between items-center mb-6">
          <div className="flex items-center gap-4">
            <h2 className="text-2xl font-bold">{selectedBathroom.name} - Options Summary</h2>
            <select
              value={selectedBathroom.id}
              onChange={(e) => {
                const bathroom = bathrooms.find(b => b.id === e.target.value);
                if (bathroom) {
                  setSelectedBathroom(bathroom);
                }
              }}
              className="border rounded px-3 py-2 text-sm bg-white"
            >
              {bathrooms.map(bathroom => (
                <option key={bathroom.id} value={bathroom.id}>
                  Switch to: {bathroom.name}
                </option>
              ))}
            </select>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => exportToPDF('Summary', 'summary-content')}
              className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2"
              title="Export to PDF"
            >
              üì•
              Export PDF
            </button>
            <button
              onClick={() => {
                  setView('compare');
                  if (typeof window !== 'undefined' && window.sc_log_pv) {
                    try { window.sc_log_pv(); } catch(e) {}
                  }
                }}
              className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
            >
              ‚Üê Back to Configure
            </button>
          </div>
        </div>

        <div id="summary-content" className="grid gap-6" style={{ gridTemplateColumns: `repeat(${selectedBathroom.options.length}, minmax(400px, 1fr))` }}>
          {selectedBathroom.options.map(option => {
            const total = calculateTotal(option);
            const isSelected = finalSelections[selectedBathroom.id] === option.id;

            return (
              <div key={option.id} className={`bg-white rounded-lg shadow-lg overflow-hidden ${isSelected ? 'ring-4 ring-green-500' : ''}`}>
                <div className={`p-4 ${isSelected ? 'bg-green-600 text-white' : 'bg-gray-800 text-white'}`}>
                  <h3 className="text-2xl font-bold">{option.name}</h3>
                  {isSelected && <p className="text-sm mt-1">‚úì Currently Selected</p>}
                </div>

                <div className="p-6 space-y-4">
                  {Object.entries(option.selections).map(([category, item]) => {
                    if (!item) return null;
                    
                    return (
                      <div key={category} className="border-b pb-4">
                        <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">
                          {category.replace(/_/g, ' ')}
                        </h4>
                        <div className="flex gap-3">
                          {(item.image_data || item.image_url) && (
                            <img
                              src={item.image_data || item.image_url}
                              alt={item.model}
                              className="w-20 h-20 object-cover rounded"
                              onError={(e) => e.target.style.display = 'none'}
                            />
                          )}
                          <div className="flex-1">
                            <p className="font-bold text-gray-900">{item.brand}</p>
                            <p className="text-sm text-gray-600">{item.model}</p>
                            {item.description && (
                              <p className="text-xs text-gray-500 mt-1 line-clamp-2">{item.description}</p>
                            )}
                            {(item.unit_price ?? item.price) && (
                              <p className="text-lg font-semibold text-blue-600 mt-1">
                                {currency}{(item.unit_price ?? item.price).toFixed(2)}
                              </p>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}

                  {option.accessories && option.accessories.filter(a => a.checked).length > 0 && (
                    <div className="border-t pt-4">
                      <h4 className="text-xs font-semibold text-gray-500 uppercase mb-2">Accessories</h4>
                      <ul className="space-y-1">
                        {option.accessories.filter(a => a.checked).map((acc, idx) => (
                          <li key={idx} className="text-sm text-gray-700">‚úì {acc.name}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>

                <div className="bg-blue-50 p-6 border-t">
                  <div className="text-3xl font-bold text-blue-900">
                    {currency}{total.toLocaleString('en-IN', { maximumFractionDigits: 2 })}
                  </div>
                  <p className="text-sm text-blue-700 mt-1">Total Cost</p>
                </div>

                <div className="p-4 bg-gray-50">
                  <button
                    onClick={async () => {
                      const newSelections = { ...finalSelections, [selectedBathroom.id]: option.id };
                      setFinalSelections(newSelections);
                      await saveToStorage({ selections: newSelections });
                      setNotification({ type: 'success', message: `${option.name} selected for ${selectedBathroom.name}!` });
                      setTimeout(() => setNotification(null), 3000);
                    }}
                    className={`w-full py-3 rounded-lg font-bold text-lg ${
                      isSelected
                        ? 'bg-green-600 text-white'
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                    }`}
                  >
                    {isSelected ? '‚úì Selected' : 'Select This Option'}
                  </button>
                </div>
              </div>
            );
          })}
        </div>

        {/* Option Comparison Section */}
        {selectedBathroom.options.length > 1 && (
          <div className="mt-8 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg shadow-lg p-6 border-2 border-green-200">
            <h3 className="text-2xl font-bold mb-4 text-gray-900">üí∞ Cost Comparison</h3>
            
            <div className="mb-4">
              <label className="block font-semibold mb-2 text-gray-700">Select Baseline for Comparison:</label>
              <select
                value={comparisonBaseline || ''}
                onChange={(e) => setComparisonBaseline(e.target.value || null)}
                className="border-2 border-gray-300 rounded-lg px-4 py-2 w-full max-w-md focus:border-blue-500 focus:outline-none"
              >
                <option value="">-- Select Option to Compare Against --</option>
                {selectedBathroom.options.map(option => (
                  <option key={option.id} value={option.id}>
                    {option.name}
                  </option>
                ))}
              </select>
            </div>

            {comparisonBaseline && (() => {
              const baseline = selectedBathroom.options.find(o => o.id === comparisonBaseline);
              if (!baseline) return null;
              
              const baselineTotal = calculateTotal(baseline);
              
              return (
                <div className="space-y-6">
                  <div className="bg-white rounded-lg p-6 border-2 border-gray-300 shadow">
                    <h4 className="font-bold text-xl mb-2">Baseline: {baseline.name}</h4>
                    <p className="text-3xl font-bold text-gray-900">{currency}{baselineTotal.toFixed(2)}</p>
                  </div>

                  <div>
                    <h4 className="font-semibold text-lg mb-4 text-gray-800">Comparison with Other Options:</h4>
                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                    {selectedBathroom.options.filter(opt => opt.id !== comparisonBaseline).map(option => {
                      const optionTotal = calculateTotal(option);
                      const delta = optionTotal - baselineTotal;
                      const isHigher = delta > 0;
                      const isLower = delta < 0;
                      
                      // Calculate per-category deltas
                      const categoryDeltas = {};
                      const allCategories = new Set([
                        ...Object.keys(baseline.selections || {}),
                        ...Object.keys(option.selections || {})
                      ]);
                      
                      allCategories.forEach(category => {
                        const baseItem = baseline.selections?.[category];
                        const optItem = option.selections?.[category];
                        const basePrice = baseItem?.unit_price ?? baseItem?.price ?? 0;
                        const optPrice = optItem?.unit_price ?? optItem?.price ?? 0;
                        const catDelta = optPrice - basePrice;
                        if (catDelta !== 0) {
                          categoryDeltas[category] = catDelta;
                        }
                      });
                      
                      return (
                        <div key={option.id} className={`bg-white rounded-lg p-5 border-2 shadow-sm ${
                          isHigher ? 'border-red-300' : isLower ? 'border-green-300' : 'border-gray-300'
                        }`}>
                          <h5 className="font-bold text-xl mb-3">{option.name}</h5>
                          <div className="mb-4">
                            <p className="text-sm text-gray-600 mb-1">Total Cost</p>
                            <p className="text-2xl font-bold">{currency}{optionTotal.toFixed(2)}</p>
                          </div>
                          <div className={`text-3xl font-bold mb-4 pb-4 border-b ${
                            isHigher ? 'text-red-600' : isLower ? 'text-green-600' : 'text-gray-600'
                          }`}>
                            {isHigher && '+'}{delta.toFixed(2)}
                            <span className="text-base ml-2">vs baseline</span>
                          </div>
                          
                          {Object.keys(categoryDeltas).length > 0 && (
                            <div className="border-t pt-3 mt-3">
                              <p className="text-xs font-semibold text-gray-600 mb-2">Category Deltas:</p>
                              <div className="space-y-1">
                                {Object.entries(categoryDeltas).map(([cat, catDelta]) => (
                                  <div key={cat} className="flex justify-between text-xs">
                                    <span className="text-gray-700">{cat.replace(/_/g, ' ')}</span>
                                    <span className={`font-semibold ml-2 whitespace-nowrap ${
                                      catDelta > 0 ? 'text-red-600' : 'text-green-600'
                                    }`}>
                                      {catDelta > 0 && '+'}{catDelta.toFixed(2)}
                                    </span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  </div>
                </div>
              );
            })()}
          </div>
        )}
      </div>
    );
  };

  const BathroomOverview = () => {
    const calculateOptionTotal = (option) => {
      let total = 0;
      Object.values(option.selections).forEach(item => {
        const price = item?.unit_price ?? item?.price;
        if (price) total += price;
      });
      return total;
    };

    const getSelectedOption = (bathroom) => {
      const selectedOptionId = finalSelections[bathroom.id];
      return bathroom.options.find(o => o.id === selectedOptionId);
    };

    // Group items by category for better display
    const getCategorizedItems = (selections) => {
      const categories = {
        'Fixtures': ['basin', 'wc'],
        'Faucets': ['mixer', 'concealed_body'],
        'Shower System': ['hand_shower', 'hand_shower_hose', 'hand_shower_outlet', 'hand_shower_rail', 
                          'overhead_shower', 'shower_arm', 'shower_panel', 'diverter'],
        'Tiles': ['wall_tiles', 'feature_wall_tiles', 'floor_tiles'],
        'Other': ['accessory', 'drain', 'health_faucet']
      };

      // Add custom categories to their own group
      const customCatKeys = customCategories.map(c => {
        const catName = typeof c === 'string' ? c : c.name;
        return catName.toLowerCase().replace(/\s+/g, '_');
      });
      
      if (customCatKeys.length > 0) {
        categories['Custom'] = customCatKeys;
      }

      const grouped = {};
      Object.entries(categories).forEach(([groupName, catKeys]) => {
        grouped[groupName] = [];
        catKeys.forEach(key => {
          if (selections[key]) {
            grouped[groupName].push({ category: key, item: selections[key] });
          }
        });
      });

      return grouped;
    };

    return (
      <div className="max-w-5xl mx-auto p-6">
        <div className="mb-8 flex justify-between items-start">
          <div>
            <h2 className="text-4xl font-bold text-gray-900 mb-2">Project Overview</h2>
            <p className="text-gray-600">Quick view of all bathroom selections and total costs</p>
          </div>
          <button
            onClick={() => exportToPDF('Overview', 'overview-content')}
            className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2"
            title="Export to PDF"
          >
            üì•
            Export PDF
          </button>
        </div>

        <div id="overview-content">
        {bathrooms.length === 0 ? (
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center">
            <p className="text-yellow-800 text-lg mb-4">No bathrooms configured yet.</p>
            <button
              onClick={() => setView('configure')}
              className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
            >
              Configure Bathrooms
            </button>
          </div>
        ) : (
          <div className="space-y-8">
            {bathrooms.map(bathroom => {
              const selectedOption = getSelectedOption(bathroom);
              const total = selectedOption ? calculateOptionTotal(selectedOption) : 0;
              const categorized = selectedOption ? getCategorizedItems(selectedOption.selections) : {};

              return (
                <div key={bathroom.id} className="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                  {/* Header */}
                  <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6">
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 flex-wrap">
                          <h3 className="text-2xl font-bold">{bathroom.name}</h3>
                          <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                            bathroom.importance === 'high' ? 'bg-red-500' :
                            bathroom.importance === 'medium' ? 'bg-yellow-500' :
                            'bg-green-500'
                          }`}>
                            {bathroom.importance.toUpperCase()} PRIORITY
                          </span>
                        </div>
                        {selectedOption && (
                          <p className="text-blue-100 mt-2">
                            Selected: <span className="font-semibold">{selectedOption.name}</span>
                          </p>
                        )}
                      </div>
                      <div className="text-right ml-4">
                        <div className="text-4xl font-bold">
                          {currency}{(total / 1000).toFixed(1)}K
                        </div>
                        <p className="text-blue-100 text-xs mt-1">
                          {currency}{total.toLocaleString('en-IN')}
                        </p>
                      </div>
                    </div>
                  </div>

                  {selectedOption ? (
                    <div className="p-6">
                      {/* Categorized Items in vertical cards */}
                      <div className="space-y-6">
                        {Object.entries(categorized).map(([groupName, items]) => {
                          if (items.length === 0) return null;
                          
                          return (
                            <div key={groupName}>
                              <h4 className="text-sm font-bold text-gray-500 uppercase mb-3 pb-2 border-b-2 border-blue-600 flex items-center justify-between">
                                <span>{groupName}</span>
                                <span className="text-blue-600">{items.length} item{items.length > 1 ? 's' : ''}</span>
                              </h4>
                              <div className="space-y-3">
                                {items.map(({ category, item }) => (
                                  <div key={category} className="border rounded-lg p-4 hover:shadow-md transition-shadow bg-white flex gap-4">
                                    {(item.image_data || item.image_url) && (
                                      <img
                                        src={item.image_data || item.image_url}
                                        alt={item.model}
                                        className="w-20 h-20 object-cover rounded flex-shrink-0"
                                        onError={(e) => e.target.style.display = 'none'}
                                      />
                                    )}
                                    <div className="flex-1 min-w-0">
                                      <p className="text-xs text-gray-500 uppercase mb-1">
                                        {getCategoryLabel(category)}
                                      </p>
                                      <p className="font-bold text-gray-900">{item.brand}</p>
                                      <p className="text-sm text-gray-600 mt-1">{item.model}</p>
                                      {item.series && (
                                        <p className="text-xs text-gray-500 mt-1">Series: {item.series}</p>
                                      )}
                                    </div>
                                    {(item.unit_price ?? item.price) && (
                                      <div className="text-right flex-shrink-0">
                                        <p className="text-lg font-semibold text-blue-600">
                                          {currency}{(item.unit_price ?? item.price).toLocaleString('en-IN')}
                                        </p>
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      {/* Accessories */}
                      {selectedOption.accessories && selectedOption.accessories.filter(a => a.checked).length > 0 && (
                        <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                          <h5 className="font-bold text-sm text-blue-900 mb-3">‚úì Included Accessories</h5>
                          <div className="grid grid-cols-2 gap-2">
                            {selectedOption.accessories.filter(a => a.checked).map((acc, idx) => (
                              <div key={idx} className="text-sm text-blue-800 flex items-center">
                                <span className="text-blue-600 mr-2">‚úì</span>
                                {acc.name}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Action Button */}
                      <div className="mt-6 text-center">
                        <button
                          onClick={() => {
                            setSelectedBathroom(bathroom);
                            setView('summary');
                          }}
                          className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                        >
                          View All Options for {bathroom.name}
                        </button>
                      </div>
                    </div>
                  ) : (
                    <div className="p-8 text-center bg-gray-50">
                      <p className="text-gray-600 mb-4 text-lg">‚ö†Ô∏è No option selected yet</p>
                      <button
                        onClick={() => {
                          setSelectedBathroom(bathroom);
                          setView('compare');
                        }}
                        className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                      >
                        Configure {bathroom.name}
                      </button>
                    </div>
                  )}

                  {/* Renders Section - Always show if renders exist, regardless of option selection */}
                  {bathroom.renders && bathroom.renders.length > 0 && (
                    <div className="p-6 pt-0">
                      <div className="border-t pt-6 mt-6">
                        <h5 className="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2">
                          üé® Rendered Images
                          <span className="text-sm font-normal text-gray-500">({bathroom.renders.length})</span>
                        </h5>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                          {bathroom.renders.map(render => (
                            <div key={render.id} className="group relative">
                              <img
                                src={render.data}
                                alt={render.name}
                                className="w-full h-48 object-cover rounded-lg border-2 border-gray-200 hover:border-blue-500 transition-all cursor-pointer shadow-sm hover:shadow-md"
                                onClick={() => {
                                  // Open in new tab for full view
                                  const win = window.open();
                                  win.document.write(`<img src="${render.data}" style="max-width:100%;height:auto;"/>`);
                                }}
                              />
                              <p className="text-xs text-gray-500 mt-1 truncate">{render.name}</p>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              );
            })}

            {/* Grand Total */}
            <div className="bg-gradient-to-r from-green-600 to-green-800 text-white rounded-xl shadow-lg p-8">
              <div className="text-center">
                <p className="text-green-100 text-sm uppercase tracking-wide mb-2">Project Grand Total</p>
                <div className="text-6xl font-bold mb-2">
                  {currency}{bathrooms.reduce((sum, bathroom) => {
                    const selectedOption = getSelectedOption(bathroom);
                    return sum + (selectedOption ? calculateOptionTotal(selectedOption) : 0);
                  }, 0).toLocaleString('en-IN', { maximumFractionDigits: 0 })}
                </div>
                <p className="text-green-100 text-sm">
                  {bathrooms.filter(b => finalSelections[b.id]).length} of {bathrooms.length} bathrooms configured
                </p>
              </div>
            </div>
          </div>
        )}
        </div>
      </div>
    );
  };

  const ProcurementList = () => {
    const procurementList = [];

    bathrooms.forEach(bathroom => {
      const selectedOptionId = finalSelections[bathroom.id];
      if (selectedOptionId) {
        const selectedOption = bathroom.options.find(o => o.id === selectedOptionId);
        if (selectedOption) {
          Object.entries(selectedOption.selections).forEach(([category, item]) => {
            if (item) {
              // Look up current item data from items array to get latest vendor info
              const currentItem = items.find(i => i.item_id === item.item_id) || item;
              const existing = procurementList.find(p => p.item_id === currentItem.item_id);
              if (existing) {
                existing.quantity += 1;
                existing.bathrooms.push(bathroom.name);
                existing.options.push(selectedOption.name);
                existing.categories.push(category);
              } else {
                procurementList.push({
                  ...currentItem,
                  quantity: 1,
                  bathrooms: [bathroom.name],
                  options: [selectedOption.name],
                  categories: [category]
                });
              }
            }
          });
        }
      }
    });

    // Group by brand (existing behavior)
    const groupedByBrand = procurementList.reduce((acc, item) => {
      const isTile = ['wall_tiles', 'feature_wall_tiles', 'floor_tiles'].includes(item.category);
      const key = isTile ? 'TILES' : (item.brand || 'Other');
      if (!acc[key]) acc[key] = [];
      acc[key].push(item);
      return acc;
    }, {});

    // Group by vendor (normalized for consolidation)
    const vendorMap = procurementList.reduce((acc, item) => {
      const rawName = item.vendor_name || '';
      const normalizedKey = rawName.trim().toLowerCase() || 'unassigned_vendor';
      
      if (!acc[normalizedKey]) {
        // First occurrence - set initial display name
        const displayName = normalizedKey === 'unassigned_vendor' ? 'Unassigned Vendor' : rawName.trim();
        acc[normalizedKey] = {
          displayName: displayName,
          items: []
        };
      } else {
        // Subsequent occurrences - prefer capitalized versions for display
        const currentDisplay = acc[normalizedKey].displayName;
        const newTrimmed = rawName.trim();
        // If current is lowercase and new has uppercase, prefer the new one
        if (currentDisplay !== 'Unassigned Vendor' && 
            currentDisplay[0] === currentDisplay[0].toLowerCase() && 
            newTrimmed[0] === newTrimmed[0].toUpperCase()) {
          acc[normalizedKey].displayName = newTrimmed;
        }
      }
      
      acc[normalizedKey].items.push(item);
      return acc;
    }, {});
    
    const groupedByVendor = Object.entries(vendorMap).reduce((acc, [key, data]) => {
      acc[data.displayName] = data.items;
      return acc;
    }, {});

    // Separate tiles and brands for better display
    const tilesGroup = groupedByBrand['TILES'] || [];
    const brandGroups = Object.entries(groupedByBrand).filter(([key]) => key !== 'TILES');
    const vendorGroups = Object.entries(groupedByVendor).sort(([a], [b]) => {
      // Sort: assigned vendors first, then "Unassigned Vendor"
      if (a === 'Unassigned Vendor') return 1;
      if (b === 'Unassigned Vendor') return -1;
      return a.localeCompare(b);
    });

    const totalCost = procurementList.reduce(
      (sum, item) => {
        const price = item.unit_price ?? item.price;
        return sum + (price ? price * item.quantity : 0);
      },
      0
    );

    const exportToExcel = async () => {
      try {
        debug('Loading XLSX for procurement export...');
        
        if (!window.XLSX) {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        const excelData = [];
        
        if (procurementViewMode === 'vendors') {
          // Export by vendors
          vendorGroups.forEach(([vendor, vendorItems]) => {
            const headerRow = {
              Vendor: `===== ${vendor} =====`,
              Brand: '',
              Model: ''
            };
            if (visibleColumns.bathroom) headerRow.Bathroom = '';
            if (visibleColumns.option) headerRow.Option = '';
            if (visibleColumns.category) headerRow.Category = '';
            headerRow.Quantity = '';
            if (showPrices) {
              headerRow['Unit Price'] = '';
              headerRow['Total Price'] = '';
            }
            excelData.push(headerRow);
            
            vendorItems.forEach(item => {
              const price = item.unit_price ?? item.price;
              const row = {
                Vendor: '',
                Brand: item.brand,
                Model: item.model
              };
              if (visibleColumns.bathroom) row.Bathroom = item.bathrooms.join(', ');
              if (visibleColumns.option) row.Option = item.options.join(', ');
              if (visibleColumns.category) row.Category = getCategoryLabel(item.category);
              row.Quantity = item.quantity;
              if (showPrices) {
                row['Unit Price'] = price || 'TBA';
                row['Total Price'] = price ? price * item.quantity : 'TBA';
              }
              excelData.push(row);
            });
            
            if (showPrices) {
              const vendorTotal = vendorItems.reduce((sum, item) => {
                const price = item.unit_price ?? item.price;
                return sum + (price ? price * item.quantity : 0);
              }, 0);
              
              const subtotalRow = {
                Vendor: '',
                Brand: '',
                Model: ''
              };
              if (visibleColumns.bathroom) subtotalRow.Bathroom = '';
              if (visibleColumns.option) subtotalRow.Option = '';
              if (visibleColumns.category) subtotalRow.Category = '';
              subtotalRow.Quantity = '';
              subtotalRow['Unit Price'] = `${vendor} Subtotal`;
              subtotalRow['Total Price'] = vendorTotal;
              excelData.push(subtotalRow);
            }
            
            excelData.push({});
          });
        } else {
          // Export by brands (existing behavior)
          Object.entries(groupedByBrand).forEach(([brand, brandItems]) => {
            brandItems.forEach(item => {
              const price = item.unit_price ?? item.price;
              excelData.push({
                Brand: brand,
                Model: item.model,
                Category: getCategoryLabel(item.category),
                'Used In': item.bathrooms.join(', '),
                Quantity: item.quantity,
                'Unit Price': showPrices ? (price || 'TBA') : '-',
                'Total Price': showPrices
                  ? (price ? price * item.quantity : 'TBA')
                  : '-'
              });
            });
          });
        }

        if (showPrices) {
          excelData.push({});
          if (procurementViewMode === 'vendors') {
            const grandTotalRow = {
              Vendor: '',
              Brand: '',
              Model: ''
            };
            if (visibleColumns.bathroom) grandTotalRow.Bathroom = '';
            if (visibleColumns.option) grandTotalRow.Option = '';
            if (visibleColumns.category) grandTotalRow.Category = '';
            grandTotalRow.Quantity = '';
            grandTotalRow['Unit Price'] = 'GRAND TOTAL';
            grandTotalRow['Total Price'] = totalCost;
            excelData.push(grandTotalRow);
          } else {
            excelData.push({
              Brand: '',
              Model: '',
              Category: '',
              'Used In': '',
              Quantity: '',
              'Unit Price': 'GRAND TOTAL',
              'Total Price': totalCost
            });
          }
        }

        const ws = window.XLSX.utils.json_to_sheet(excelData);
        const wb = window.XLSX.utils.book_new();
        window.XLSX.utils.book_append_sheet(wb, ws, 'Procurement');

        window.XLSX.writeFile(wb, `Procurement-${new Date().toISOString().split('T')[0]}.xlsx`);
        
        debug('‚úì Procurement list exported to Excel');
        setNotification({ type: 'success', message: 'Excel file downloaded!' });
        setTimeout(() => setNotification(null), 3000);
      } catch (error) {
        debug(`Excel export error: ${error.message}`);
        setNotification({ type: 'error', message: 'Export failed. See debug log.' });
        setTimeout(() => setNotification(null), 3000);
      }
    };

    return (
      <div className="max-w-6xl mx-auto p-6">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-2xl font-bold">Procurement List</h2>
          <div className="bg-white border-2 border-gray-300 rounded-lg p-1 flex gap-1">
            <button
              onClick={() => setProcurementViewMode('items')}
              className={`px-4 py-2 rounded transition ${
                procurementViewMode === 'items'
                  ? 'bg-blue-600 text-white'
                  : 'bg-transparent text-gray-700 hover:bg-gray-100'
              }`}
            >
              By Items
            </button>
            <button
              onClick={() => setProcurementViewMode('vendors')}
              className={`px-4 py-2 rounded transition ${
                procurementViewMode === 'vendors'
                  ? 'bg-blue-600 text-white'
                  : 'bg-transparent text-gray-700 hover:bg-gray-100'
              }`}
            >
              By Vendors
            </button>
          </div>
        </div>
        <div className="flex justify-end items-center mb-6">
          <div className="flex gap-4 items-center">
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                checked={showPrices}
                onChange={(e) => setShowPrices(e.target.checked)}
              />
              Show Prices
            </label>
            {procurementViewMode === 'vendors' && (
              <>
                <span className="text-gray-400">|</span>
                <label className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={visibleColumns.bathroom}
                    onChange={(e) => setVisibleColumns({...visibleColumns, bathroom: e.target.checked})}
                  />
                  Bathroom
                </label>
                <label className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={visibleColumns.option}
                    onChange={(e) => setVisibleColumns({...visibleColumns, option: e.target.checked})}
                  />
                  Option
                </label>
                <label className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={visibleColumns.category}
                    onChange={(e) => setVisibleColumns({...visibleColumns, category: e.target.checked})}
                  />
                  Category
                </label>
              </>
            )}
            <button
              onClick={() => {
                setExportType('pdf');
                setShowExportSummary(true);
              }}
              className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2"
              title="Export to PDF"
            >
              üì•
              Export PDF
            </button>
            <button
              onClick={exportToExcel}
              className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
            >
              üì•
              Export Excel
            </button>
          </div>
        </div>

        <div id="procurement-content">
        {procurementList.length === 0 ? (
          <div className="bg-yellow-50 border border-yellow-200 rounded p-4">
            <p className="text-yellow-800">
              No items selected. Configure bathrooms and select final options first.
            </p>
          </div>
        ) : procurementViewMode === 'vendors' ? (
          /* VENDOR VIEW */
          <div className="space-y-6">
            {vendorGroups.map(([vendor, vendorItems]) => {
              const vendorTotal = vendorItems.reduce((sum, item) => {
                const price = item.unit_price ?? item.price;
                return sum + (price ? price * item.quantity : 0);
              }, 0);
              
              return (
                <div key={vendor} className={`rounded shadow p-6 ${
                  vendor === 'Unassigned Vendor' 
                    ? 'bg-gray-50 border-2 border-gray-300' 
                    : 'bg-white'
                }`}>
                  <h3 className="text-xl font-bold mb-4 border-b pb-2">
                    {vendor === 'Unassigned Vendor' ? 'üì¶ ' : 'üè¢ '}{vendor}
                  </h3>
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-4 py-2 text-left">Brand</th>
                        <th className="px-4 py-2 text-left">Model</th>
                        {visibleColumns.bathroom && <th className="px-4 py-2 text-left">Bathroom</th>}
                        {visibleColumns.option && <th className="px-4 py-2 text-left">Option</th>}
                        {visibleColumns.category && <th className="px-4 py-2 text-left">Category</th>}
                        <th className="px-4 py-2 text-center">Qty</th>
                        {showPrices && <th className="px-4 py-2 text-right">Unit Price</th>}
                        {showPrices && <th className="px-4 py-2 text-right">Total</th>}
                      </tr>
                    </thead>
                    <tbody>
                      {vendorItems.map((item, idx) => (
                        <tr key={`${item.item_id}-${idx}`} className="border-t">
                          <td className="px-4 py-2 text-sm">{item.brand}</td>
                          <td className="px-4 py-2">{item.model}</td>
                          {visibleColumns.bathroom && <td className="px-4 py-2 text-sm">{item.bathrooms.join(', ')}</td>}
                          {visibleColumns.option && <td className="px-4 py-2 text-sm">{item.options.join(', ')}</td>}
                          {visibleColumns.category && <td className="px-4 py-2 text-sm">{getCategoryLabel(item.category)}</td>}
                          <td className="px-4 py-2 text-center font-semibold">{item.quantity}</td>
                          {showPrices && (
                            <td className="px-4 py-2 text-right">
                              {(item.unit_price ?? item.price) ? `${currency}${(item.unit_price ?? item.price).toFixed(2)}` : 'TBA'}
                            </td>
                          )}
                          {showPrices && (
                            <td className="px-4 py-2 text-right font-semibold">
                              {(item.unit_price ?? item.price)
                                ? `${currency}${((item.unit_price ?? item.price) * item.quantity).toFixed(2)}`
                                : 'TBA'}
                            </td>
                          )}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  {showPrices && vendorTotal > 0 && (
                    <div className="mt-4 text-right">
                      <span className="font-bold text-lg">
                        Vendor Subtotal: {currency}{vendorTotal.toFixed(2)}
                      </span>
                    </div>
                  )}
                  {/* Show vendor metadata if available */}
                  {vendor !== 'Unassigned Vendor' && vendorItems[0] && (vendorItems[0].vendor_quote_ref || vendorItems[0].vendor_link) && (
                    <div className="mt-4 pt-4 border-t text-sm text-gray-600">
                      {vendorItems[0].vendor_quote_ref && (
                        <div><strong>Quote Ref:</strong> {vendorItems[0].vendor_quote_ref}</div>
                      )}
                      {vendorItems[0].vendor_link && (
                        <div><strong>Contact:</strong> {vendorItems[0].vendor_link}</div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
            
            {showPrices && (
              <div className="bg-blue-50 rounded p-6">
                <div className="text-2xl font-bold text-right">
                  Grand Total: {currency}{totalCost.toFixed(2)}
                </div>
              </div>
            )}
          </div>
        ) : (
          /* ITEMS VIEW (BY BRAND) */
          <div className="space-y-6">
            {/* Brand Sections */}
            {brandGroups.map(([brand, brandItems]) => (
              <div key={brand} className="bg-white rounded shadow p-6">
                <h3 className="text-xl font-bold mb-4 border-b pb-2">{brand}</h3>
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-2 text-left">Model</th>
                      <th className="px-4 py-2 text-left">Category</th>
                      <th className="px-4 py-2 text-left">Used In</th>
                      <th className="px-4 py-2 text-center">Qty</th>
                      {showPrices && <th className="px-4 py-2 text-right">Unit Price</th>}
                      {showPrices && <th className="px-4 py-2 text-right">Total</th>}
                    </tr>
                  </thead>
                  <tbody>
                    {brandItems.map(item => (
                      <tr key={item.item_id} className="border-t">
                        <td className="px-4 py-2">{item.model}</td>
                        <td className="px-4 py-2 text-sm">{getCategoryLabel(item.category)}</td>
                        <td className="px-4 py-2 text-sm">{item.bathrooms.join(', ')}</td>
                        <td className="px-4 py-2 text-center font-semibold">{item.quantity}</td>
                        {showPrices && (
                          <td className="px-4 py-2 text-right">
                            {(item.unit_price ?? item.price) ? `${currency}${(item.unit_price ?? item.price).toFixed(2)}` : 'TBA'}
                          </td>
                        )}
                        {showPrices && (
                          <td className="px-4 py-2 text-right font-semibold">
                            {(item.unit_price ?? item.price)
                              ? `${currency}${((item.unit_price ?? item.price) * item.quantity).toFixed(2)}`
                              : 'TBA'}
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ))}

            {/* Tiles Section */}
            {tilesGroup.length > 0 && (
              <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded shadow p-6 border-2 border-orange-200">
                <h3 className="text-xl font-bold mb-4 border-b-2 border-orange-400 pb-2 text-orange-900">
                  üèóÔ∏è TILES
                </h3>
                <table className="w-full">
                  <thead className="bg-orange-100">
                    <tr>
                      <th className="px-4 py-2 text-left">Brand</th>
                      <th className="px-4 py-2 text-left">Model</th>
                      <th className="px-4 py-2 text-left">Type</th>
                      <th className="px-4 py-2 text-left">Used In</th>
                      <th className="px-4 py-2 text-center">Qty</th>
                      {showPrices && <th className="px-4 py-2 text-right">Unit Price</th>}
                      {showPrices && <th className="px-4 py-2 text-right">Total</th>}
                    </tr>
                  </thead>
                  <tbody>
                    {tilesGroup.map(item => (
                      <tr key={item.item_id} className="border-t border-orange-200">
                        <td className="px-4 py-2 font-semibold">{item.brand || 'Generic'}</td>
                        <td className="px-4 py-2">{item.model}</td>
                        <td className="px-4 py-2 text-sm">
                          <span className={`px-2 py-1 rounded text-xs ${
                            item.category === 'wall_tiles' ? 'bg-blue-100 text-blue-800' :
                            item.category === 'feature_wall_tiles' ? 'bg-purple-100 text-purple-800' :
                            'bg-green-100 text-green-800'
                          }`}>
                            {getCategoryLabel(item.category)}
                          </span>
                        </td>
                        <td className="px-4 py-2 text-sm">{item.bathrooms.join(', ')}</td>
                        <td className="px-4 py-2 text-center font-semibold">{item.quantity}</td>
                        {showPrices && (
                          <td className="px-4 py-2 text-right">
                            {(item.unit_price ?? item.price) ? `${currency}${(item.unit_price ?? item.price).toFixed(2)}` : 'TBA'}
                          </td>
                        )}
                        {showPrices && (
                          <td className="px-4 py-2 text-right font-semibold">
                            {(item.unit_price ?? item.price)
                              ? `${currency}${((item.unit_price ?? item.price) * item.quantity).toFixed(2)}`
                              : 'TBA'}
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}

            {showPrices && (
              <div className="bg-blue-50 rounded p-6">
                <div className="text-2xl font-bold text-right">
                  Grand Total: {currency}{totalCost.toFixed(2)}
                </div>
              </div>
            )}
          </div>
        )}
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Introduction Modal */}
      {showIntroduction && (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-8 rounded-t-xl">
              <h1 className="text-4xl font-bold mb-3">üè† Welcome to Bathroom Planner!</h1>
              <p className="text-blue-100 text-lg">Your DIY renovation companion</p>
            </div>
            
            <div className="p-8">
              <div className="mb-6">
                <h2 className="text-2xl font-bold text-gray-900 mb-3">What is this tool?</h2>
                <p className="text-gray-700 leading-relaxed mb-4">
                  Born from the chaos of a real DIY house construction project, this tool helps you 
                  <strong> organize, compare, and decide</strong> on bathroom fittings without drowning in spreadsheets.
                </p>
                <p className="text-gray-700 leading-relaxed">
                  Whether you're renovating one bathroom or building an entire house, this tool lets you:
                </p>
              </div>

              <div className="grid md:grid-cols-2 gap-4 mb-6">
                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <h3 className="font-bold text-blue-900 mb-2">üìä Organize Products</h3>
                  <p className="text-sm text-gray-700">Build your database of basins, WCs, faucets, tiles, and accessories with prices and images.</p>
                </div>
                
                <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                  <h3 className="font-bold text-purple-900 mb-2">‚öñÔ∏è Compare Options</h3>
                  <p className="text-sm text-gray-700">Create multiple options for each bathroom (Budget vs Premium) and compare them side-by-side.</p>
                </div>
                
                <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                  <h3 className="font-bold text-green-900 mb-2">üí∞ Track Costs</h3>
                  <p className="text-sm text-gray-700">See real-time totals, compare option prices, and calculate project-wide costs.</p>
                </div>
                
                <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
                  <h3 className="font-bold text-orange-900 mb-2">üì§ Share & Decide</h3>
                  <p className="text-sm text-gray-700">Export professional PDFs to share with family, designers, or procurement teams.</p>
                </div>
              </div>

              <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                <h3 className="font-bold text-yellow-900 mb-2">üí° Perfect For:</h3>
                <ul className="text-sm text-gray-700 space-y-1">
                  <li>‚úì DIY home renovators comparing products</li>
                  <li>‚úì Interior designers managing multiple bathroom projects</li>
                  <li>‚úì Homebuilders tracking fittings across bathrooms</li>
                  <li>‚úì Anyone tired of messy spreadsheets!</li>
                </ul>
              </div>

              <div className="border-t pt-6">
                <h3 className="font-bold text-gray-900 mb-3">Quick Start:</h3>
                <ol className="list-decimal list-inside space-y-2 text-sm text-gray-700 mb-6">
                  <li>Add your bathroom products to the <strong>Database</strong></li>
                  <li>Create your bathrooms in the <strong>Bathrooms</strong> tab</li>
                  <li>Configure product selections in <strong>Configure</strong> tab</li>
                  <li>Compare and export from <strong>Summary</strong> or <strong>Overview</strong></li>
                </ol>
              </div>

              <div className="flex gap-3">
                <button
                  onClick={async () => {
                    try {
                      if (window.storage && typeof window.storage.set === 'function') {
                        await window.storage.set('intro-seen', 'true');
                      } else {
                        localStorage.setItem('intro-seen', 'true');
                      }
                    } catch (err) {
                      debug('Could not save intro-seen flag');
                    }
                    setShowIntroduction(false);
                    debug('Introduction completed');
                  }}
                  className="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg"
                >
                  üöÄ Get Started!
                </button>
                <button
                  onClick={() => {
                    setShowIntroduction(false);
                    setView('help');
                  }}
                  className="px-6 bg-gray-200 text-gray-700 py-4 rounded-lg font-semibold hover:bg-gray-300 transition-all"
                >
                  üìñ Learn More
                </button>
              </div>
              
              <p className="text-xs text-gray-500 text-center mt-4">
                You can always access help from the <strong>Help</strong> tab in navigation
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Currency Setup Modal */}
      {showCurrencySetup && !showIntroduction && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 className="text-2xl font-bold mb-4">Welcome! üëã</h2>
            <p className="text-gray-700 mb-6">
              Let's get started by selecting your preferred currency for pricing.
            </p>
            
            <div className="space-y-3 mb-6">
              {[
                { code: 'INR', symbol: '‚Çπ', name: 'Indian Rupee (‚Çπ)' },
                { code: 'USD', symbol: '$', name: 'US Dollar ($)' },
                { code: 'EUR', symbol: '‚Ç¨', name: 'Euro (‚Ç¨)' },
                { code: 'GBP', symbol: '¬£', name: 'British Pound (¬£)' },
                { code: 'AED', symbol: 'AED', name: 'UAE Dirham (AED)' },
                { code: 'SGD', symbol: 'S$', name: 'Singapore Dollar (S$)' },
                { code: 'AUD', symbol: 'A$', name: 'Australian Dollar (A$)' }
              ].map(curr => (
                <button
                  key={curr.code}
                  onClick={async () => {
                    setCurrency(curr.symbol);
                    setCurrencyCode(curr.code);
                    try {
                      if (window.storage && typeof window.storage.set === 'function') {
                        await window.storage.set('currency-settings', JSON.stringify({ symbol: curr.symbol, code: curr.code }));
                      } else {
                        localStorage.setItem('currency-settings', JSON.stringify({ symbol: curr.symbol, code: curr.code }));
                      }
                    } catch (err) {
                      debug(`Currency save warning: ${err.message} - will use session only`);
                    }
                    setShowCurrencySetup(false);
                    debug(`‚úì Currency set to ${curr.code}`);
                    setNotification({ type: 'success', message: `Currency set to ${curr.code}` });
                    setTimeout(() => setNotification(null), 3000);
                  }}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 text-left transition-colors"
                >
                  <span className="font-semibold">{curr.symbol}</span>
                  <span className="ml-2 text-gray-700">{curr.name}</span>
                </button>
              ))}
            </div>
            
            <p className="text-xs text-gray-500 text-center">
              Your selection will be used for all pricing in the app
            </p>
          </div>
        </div>
      )}

      {/* Notification Toast */}
      {notification && (
        <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg ${
          notification.type === 'success' ? 'bg-green-600' : 'bg-red-600'
        } text-white font-semibold animate-fade-in`}>
          {notification.message}
          <button
            onClick={() => setNotification(null)}
            className="ml-4 text-white hover:text-gray-200"
          >
            ‚úï
          </button>
        </div>
      )}

      {/* Onboarding Modal */}
      {showOnboarding && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
          <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              {/* Header */}
              <div className="flex justify-between items-start mb-4">
                <h2 className="text-2xl font-bold text-gray-900">Welcome to Bathroom Planner! üõÅ</h2>
                <button
                  onClick={async () => {
                    setShowOnboarding(false);
                    try {
                      await window.storage.set('onboarding-seen', { value: 'true' });
                    } catch (err) {
                      debug(`Failed to save onboarding state: ${err.message}`);
                    }
                  }}
                  className="text-gray-400 hover:text-gray-600 text-2xl"
                >
                  ‚úï
                </button>
              </div>

              {/* Content */}
              <div className="space-y-4">
                <p className="text-gray-700">
                  This tool helps you compare bathroom options and generate procurement lists efficiently.
                </p>

                <div className="space-y-3">
                  <div className="flex items-start gap-3">
                    <div className="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
                      1
                    </div>
                    <div>
                      <h3 className="font-semibold text-gray-900">Build or Import Database</h3>
                      <p className="text-gray-600 text-sm">
                        Add products manually or import from backup. Organize items by category (basin, WC, tiles, etc.)
                      </p>
                    </div>
                  </div>

                  <div className="flex items-start gap-3">
                    <div className="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
                      2
                    </div>
                    <div>
                      <h3 className="font-semibold text-gray-900">Create Bathrooms and Options</h3>
                      <p className="text-gray-600 text-sm">
                        Define bathroom zones and create multiple options to compare. Select products for each zone.
                      </p>
                    </div>
                  </div>

                  <div className="flex items-start gap-3">
                    <div className="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
                      3
                    </div>
                    <div>
                      <h3 className="font-semibold text-gray-900">Compare Costs and Export</h3>
                      <p className="text-gray-600 text-sm">
                        Review options side-by-side, select final choices, generate procurement lists and export to Excel or PDF.
                      </p>
                    </div>
                  </div>
                </div>

                {/* Tips */}
                <div className="bg-blue-50 border border-blue-200 rounded p-4 mt-4">
                  <h3 className="font-semibold text-blue-900 mb-2">üí° Quick Tips</h3>
                  <ul className="text-sm text-blue-800 space-y-1">
                    <li>‚Ä¢ Use the Database tab to manage your product library</li>
                    <li>‚Ä¢ Create bathrooms in Configure tab to organize zones</li>
                    <li>‚Ä¢ Compare options in Overview tab before finalizing</li>
                    <li>‚Ä¢ Export procurement lists when ready to order</li>
                    <li>‚Ä¢ Data auto-saves to browser storage</li>
                  </ul>
                </div>

                <button
                  onClick={async () => {
                    setShowOnboarding(false);
                    try {
                      await window.storage.set('onboarding-seen', { value: 'true' });
                    } catch (err) {
                      debug(`Failed to save onboarding state: ${err.message}`);
                    }
                  }}
                  className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                >
                  Get Started
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Export Summary Modal */}
      {showExportSummary && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
          <div className="bg-white rounded-lg shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              {/* Header */}
              <div className="flex justify-between items-start mb-4">
                <h2 className="text-2xl font-bold text-gray-900">Export Summary üìä</h2>
                <button
                  onClick={() => setShowExportSummary(false)}
                  className="text-gray-400 hover:text-gray-600 text-2xl"
                >
                  ‚úï
                </button>
              </div>

              {(() => {
                try {
                  const analysis = analyzeExportCompleteness();
                  return (
                    <>
                      {/* Summary Stats */}
                      <div className="grid grid-cols-3 gap-4 mb-6">
                        <div className="bg-blue-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold text-blue-900">{analysis.totalBathrooms}</div>
                          <div className="text-sm text-blue-700">Total Bathrooms</div>
                        </div>
                        <div className="bg-green-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold text-green-900">{analysis.configuredBathrooms}</div>
                          <div className="text-sm text-green-700">Configured</div>
                        </div>
                        <div className="bg-yellow-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold text-yellow-900">{analysis.missingSelections.length}</div>
                          <div className="text-sm text-yellow-700">Missing Items</div>
                        </div>
                      </div>

                      {/* Incomplete Options */}
                      {analysis.incompleteOptions.length > 0 && (
                        <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                          <h3 className="font-semibold text-red-900 mb-3">‚ö†Ô∏è Incomplete Configurations</h3>
                          <ul className="space-y-2">
                            {analysis.incompleteOptions.map((item, idx) => (
                              <li key={idx} className="text-sm text-red-800">
                                ‚Ä¢ <strong>{item.bathroom}</strong>: {item.issue}
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {/* Missing Selections */}
                      {analysis.missingSelections.length > 0 && (
                        <div className="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                          <h3 className="font-semibold text-yellow-900 mb-3">üìã Missing Selections</h3>
                          <div className="space-y-2 max-h-64 overflow-y-auto">
                            {analysis.missingSelections.map((item, idx) => (
                              <div key={idx} className="text-sm bg-white p-2 rounded border border-yellow-200">
                                <strong>{item.bathroom}</strong> ‚Üí {item.option} ‚Üí 
                                <span className={item.required ? 'text-red-700 font-semibold' : 'text-yellow-700'}>
                                  {' '}{item.zone} {item.required && '(Required)'}
                                </span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* All Clear Message */}
                      {analysis.incompleteOptions.length === 0 && analysis.missingSelections.length === 0 && (
                        <div className="mb-6 bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                          <div className="text-4xl mb-2">‚úÖ</div>
                          <h3 className="font-semibold text-green-900 mb-2">All Set!</h3>
                          <p className="text-sm text-green-800">All bathrooms are fully configured and ready to export.</p>
                        </div>
                      )}
                    </>
                  );
                } catch (err) {
                  return (
                    <div className="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                      <p className="text-sm text-gray-600">Unable to analyze completeness. You can still proceed with export.</p>
                    </div>
                  );
                }
              })()}

              {/* Action Buttons */}
              <div className="flex gap-3">
                <button
                  onClick={() => setShowExportSummary(false)}
                  className="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"
                >
                  Cancel
                </button>
                <button
                  onClick={() => {
                    setShowExportSummary(false);
                    if (exportType === 'excel') {
                      exportToExcel();
                    } else if (exportType === 'pdf') {
                      exportToPDF('Procurement', 'procurement-content');
                    }
                  }}
                  className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                >
                  Proceed with Export
                </button>
              </div>

              <p className="text-xs text-gray-500 mt-4 text-center">
                Note: You can export even with missing items. This is just a completeness check.
              </p>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white shadow-md mb-6">
        {/* Main Header */}
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-3xl font-bold text-gray-800">üõÅ Bathroom Planner</h1>
              <p className="text-gray-600 text-sm mt-1">Compare options, manage procurement, export reports</p>
            </div>
            <div className="flex items-center gap-3">
              <div className="flex items-center gap-2">
                <label className="text-sm font-semibold text-gray-700">Currency:</label>
                <select
                  value={currencyCode}
                  onChange={async (e) => {
                    const selectedCurrency = [
                      { code: 'INR', symbol: '‚Çπ' },
                      { code: 'USD', symbol: '$' },
                      { code: 'EUR', symbol: '‚Ç¨' },
                      { code: 'GBP', symbol: '¬£' },
                      { code: 'AED', symbol: 'AED' },
                      { code: 'SGD', symbol: 'S$' },
                      { code: 'AUD', symbol: 'A$' },
                      { code: 'CAD', symbol: 'C$' }
                    ].find(c => c.code === e.target.value);
                    if (selectedCurrency) {
                      setCurrency(selectedCurrency.symbol);
                      setCurrencyCode(selectedCurrency.code);
                      try {
                        if (window.storage && typeof window.storage.set === 'function') {
                          await window.storage.set('currency-settings', JSON.stringify(selectedCurrency));
                        } else {
                          localStorage.setItem('currency-settings', JSON.stringify(selectedCurrency));
                        }
                      } catch (err) {}
                    }
                  }}
                  className="border-2 border-gray-300 rounded-lg px-3 py-2 text-sm font-semibold bg-white focus:border-blue-500 focus:outline-none"
                >
                  <option value="INR">‚Çπ INR</option>
                  <option value="USD">$ USD</option>
                  <option value="EUR">‚Ç¨ EUR</option>
                  <option value="GBP">¬£ GBP</option>
                  <option value="AED">AED</option>
                  <option value="SGD">S$ SGD</option>
                  <option value="AUD">A$ AUD</option>
                  <option value="CAD">C$ CAD</option>
                </select>
              </div>
              <button
                onClick={() => {
                  setView('help');
                  if (typeof window !== 'undefined' && window.sc_log_pv) {
                    try { window.sc_log_pv(); } catch(e) {}
                  }
                }}
                className="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition shadow-md flex items-center gap-2"
              >
                üìö Help
              </button>
            </div>
          </div>
        </div>

        {/* Navigation Tabs */}
        <nav className="border-t border-gray-200">
        <div className="max-w-7xl mx-auto px-6">
          <div className="flex gap-2 py-3 overflow-x-auto">
              <button
                onClick={() => {
                  setView('welcome');
                  if (typeof window !== 'undefined' && window.sc_log_pv) {
                    try { window.sc_log_pv(); } catch(e) {}
                  }
                }}
                className={`px-4 py-2 rounded ${
                  view === 'welcome' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                üëã Welcome
              </button>
              <button
                onClick={() => {
                  setView('database');
                  if (typeof window !== 'undefined' && window.sc_log_pv) {
                    try { window.sc_log_pv(); } catch(e) {}
                  }
                }}
                className={`px-4 py-2 rounded ${
                  view === 'database' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                Database ({items.length})
              </button>
              <button
                onClick={() => setView('configure')}
                className={`px-4 py-2 rounded ${
                  view === 'configure' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                Bathrooms ({bathrooms.length})
              </button>
              <button
                onClick={() => setView('compare')}
                className={`px-4 py-2 rounded ${
                  view === 'compare' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                Configure
              </button>
              <button
                onClick={() => {
                  setView('summary');
                  if (typeof window !== 'undefined' && window.sc_log_pv) {
                    try { window.sc_log_pv(); } catch(e) {}
                  }
                }}
                className={`px-4 py-2 rounded ${
                  view === 'summary' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                Summary
              </button>
              <button
                onClick={() => {
                  setView('overview');
                  if (typeof window !== 'undefined' && window.sc_log_pv) {
                    try { window.sc_log_pv(); } catch(e) {}
                  }
                }}
                className={`px-4 py-2 rounded ${
                  view === 'overview' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                Overview
              </button>
              <button
                onClick={() => {
                  setView('procurement');
                  if (typeof window !== 'undefined' && window.sc_log_pv) {
                    try { window.sc_log_pv(); } catch(e) {}
                  }
                }}
                className={`px-4 py-2 rounded ${
                  view === 'procurement' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                Procurement
              </button>
              <button
                onClick={() => {
                  setView('settings');
                  if (typeof window !== 'undefined' && window.sc_log_pv) {
                    try { window.sc_log_pv(); } catch(e) {}
                  }
                }}
                className={`px-4 py-2 rounded ${
                  view === 'settings' ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'
                }`}
              >
                Settings
              </button>
          </div>
        </div>
        </nav>
      </div>

      {view === 'welcome' && (
        <div className="max-w-5xl mx-auto p-6">
          <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl shadow-2xl p-8 mb-6">
            <h1 className="text-4xl font-bold mb-3">üè† Welcome to Bathroom Planner!</h1>
            <p className="text-blue-100 text-lg">Your DIY renovation companion</p>
          </div>
          
          <div className="bg-white rounded-lg shadow p-8 mb-6">
            <h2 className="text-2xl font-bold text-gray-900 mb-3">What is this tool?</h2>
            <p className="text-gray-700 leading-relaxed mb-4">
              Born from the chaos of a real DIY house construction project, this tool helps you 
              <strong> organize, compare, and decide</strong> on bathroom fittings without drowning in spreadsheets.
            </p>
            <p className="text-gray-700 leading-relaxed">
              Whether you're renovating one bathroom or building an entire house, this tool lets you:
            </p>
          </div>

          <div className="grid md:grid-cols-2 gap-4 mb-6">
            <div className="bg-blue-50 p-6 rounded-lg border border-blue-200">
              <h3 className="font-bold text-blue-900 mb-2 text-lg">üìä Organize Products</h3>
              <p className="text-sm text-gray-700">Build your database of basins, WCs, faucets, tiles, and accessories with prices and images.</p>
            </div>
            
            <div className="bg-purple-50 p-6 rounded-lg border border-purple-200">
              <h3 className="font-bold text-purple-900 mb-2 text-lg">‚öñÔ∏è Compare Options</h3>
              <p className="text-sm text-gray-700">Create multiple options for each bathroom (Budget vs Premium) and compare them side-by-side.</p>
            </div>
            
            <div className="bg-green-50 p-6 rounded-lg border border-green-200">
              <h3 className="font-bold text-green-900 mb-2 text-lg">üí∞ Track Costs</h3>
              <p className="text-sm text-gray-700">See real-time totals, compare option prices, and calculate project-wide costs.</p>
            </div>
            
            <div className="bg-orange-50 p-6 rounded-lg border border-orange-200">
              <h3 className="font-bold text-orange-900 mb-2 text-lg">üì§ Share & Decide</h3>
              <p className="text-sm text-gray-700">Export professional PDFs to share with family, designers, or procurement teams.</p>
            </div>
          </div>

          <div className="bg-yellow-50 border-l-4 border-yellow-400 p-6 mb-6 rounded">
            <h3 className="font-bold text-yellow-900 mb-3 text-lg">üí° Perfect For:</h3>
            <ul className="text-sm text-gray-700 space-y-2">
              <li>‚úì DIY home renovators comparing products</li>
              <li>‚úì Interior designers managing multiple bathroom projects</li>
              <li>‚úì Homebuilders tracking fittings across bathrooms</li>
              <li>‚úì Anyone tired of messy spreadsheets!</li>
            </ul>
          </div>

          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <h3 className="font-bold text-gray-900 mb-4 text-xl">üöÄ Quick Start:</h3>
            <ol className="list-decimal list-inside space-y-3 text-gray-700">
              <li className="mb-2">
                <strong>Add Products</strong> - Go to <span className="bg-gray-200 px-2 py-1 rounded font-mono text-sm">Database</span> tab and import your items or add manually
              </li>
              <li className="mb-2">
                <strong>Create Bathrooms</strong> - Go to <span className="bg-gray-200 px-2 py-1 rounded font-mono text-sm">Bathrooms</span> tab and add your bathrooms
              </li>
              <li className="mb-2">
                <strong>Configure</strong> - Use <span className="bg-gray-200 px-2 py-1 rounded font-mono text-sm">Configure</span> tab to select products for each option
              </li>
              <li className="mb-2">
                <strong>Compare</strong> - Check <span className="bg-gray-200 px-2 py-1 rounded font-mono text-sm">Summary</span> and <span className="bg-gray-200 px-2 py-1 rounded font-mono text-sm">Overview</span> tabs
              </li>
              <li>
                <strong>Export</strong> - Generate PDFs and Excel files from <span className="bg-gray-200 px-2 py-1 rounded font-mono text-sm">Procurement</span>
              </li>
            </ol>
          </div>

          <div className="text-center">
            <button
              onClick={() => setView('database')}
              className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg"
            >
              üöÄ Get Started
            </button>
            <p className="text-sm text-gray-500 mt-4">
              Need help? Check the <button onClick={() => setView('help')} className="text-blue-600 hover:underline font-semibold">Help</button> anytime
            </p>
          </div>
        </div>
      )}

      {view === 'database' && (
        <div className="max-w-7xl mx-auto p-6">
          {deleteConfirm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 max-w-md mx-4">
                <h3 className="text-xl font-bold mb-4">Confirm Delete</h3>
                <p className="mb-6">
                  Delete <strong>{deleteConfirm.item.brand} {deleteConfirm.item.model}</strong>?
                  This cannot be undone.
                </p>
                <div className="flex gap-3">
                  <button
                    onClick={confirmDelete}
                    className="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700 font-bold"
                  >
                    DELETE
                  </button>
                  <button
                    onClick={cancelDelete}
                    className="flex-1 bg-gray-400 text-white py-2 rounded hover:bg-gray-500"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}

          {items.length === 0 && (
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-8 mb-6">
              <h3 className="text-2xl font-bold text-blue-900 mb-4">üöÄ Getting Started</h3>
              <p className="text-blue-800 mb-4">
                Welcome! Your database is empty. Here's how to get started:
              </p>
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                <div className="bg-white rounded-lg p-4 border border-blue-200">
                  <div className="text-3xl mb-2">üìä</div>
                  <h4 className="font-bold text-blue-900 mb-2">Import from Excel</h4>
                  <p className="text-sm text-blue-700 mb-3">
                    Have product data in Excel? Click the Import button and select your .xlsx file.
                    Make sure your Excel has columns: Brand, Model, Type, Price, Image
                  </p>
                  <label className="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded cursor-pointer hover:bg-green-700">
                    üì§ 
                    Import Excel
                    <input type="file" accept=".xlsx,.xls" onChange={imp} className="hidden" />
                  </label>
                </div>
                
                <div className="bg-white rounded-lg p-4 border border-blue-200">
                  <div className="text-3xl mb-2">üíæ</div>
                  <h4 className="font-bold text-blue-900 mb-2">Restore from Backup</h4>
                  <p className="text-sm text-blue-700 mb-3">
                    Have a previous backup file? Import it to restore all your items, bathrooms, and selections.
                    Backup files are named: bathroom-backup-YYYY-MM-DD.json
                  </p>
                  <label className="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded cursor-pointer hover:bg-purple-700">
                    üì§ 
                    Restore Backup
                    <input type="file" accept=".json" onChange={imp} className="hidden" />
                  </label>
                </div>
              </div>
              <div className="bg-white rounded-lg p-4 border border-blue-200">
                <div className="text-3xl mb-2">‚úèÔ∏è</div>
                <h4 className="font-bold text-blue-900 mb-2">Add Items Manually</h4>
                <p className="text-sm text-blue-700">
                  Or start adding items one by one using the form below. Fill in Brand, Model, select Category, 
                  upload an image, and click Add Item.
                </p>
              </div>
              <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
                <p className="text-sm text-yellow-800">
                  <strong>üí° Tip:</strong> Your data is automatically saved in your browser. To share your product database with others 
                  or use it on another device, click "Backup All" to create a file. Others can then import this file to get 
                  your complete product list with images and prices.
                </p>
              </div>
            </div>
          )}

          <div className="flex justify-between mb-6">
            <h2 className="text-2xl font-bold">Product Database ({items.length} items)</h2>
            <div className="flex gap-2">
              {!bulkEditMode ? (
                <>
                  <button
                    onClick={exp}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                  >
                    üì•
                    Export Items
                  </button>
                  <label className="px-4 py-2 bg-green-600 text-white rounded cursor-pointer hover:bg-green-700">
                    üì§
                    Import
                    <input type="file" accept=".json,.xlsx,.xls" onChange={imp} className="hidden" />
                  </label>
                  <button
                    onClick={createBackup}
                    className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700"
                  >
                    üíæ
                    Backup All
                  </button>
                  <button
                    onClick={toggleBulkEdit}
                    className="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700"
                  >
                    üìù Bulk Edit
                  </button>
                </>
              ) : (
                <>
                  <button
                    onClick={selectAllFiltered}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                  >
                    Select All ({filtered.length})
                  </button>
                  <button
                    onClick={deselectAll}
                    className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                  >
                    Deselect All
                  </button>
                  <button
                    onClick={() => setShowBulkEditPanel(!showBulkEditPanel)}
                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                    disabled={selectedItems.length === 0}
                  >
                    Edit {selectedItems.length} Items
                  </button>
                  <button
                    onClick={toggleBulkEdit}
                    className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                  >
                    Cancel
                  </button>
                </>
              )}
            </div>
          </div>

          {bulkEditMode && selectedItems.length > 0 && showBulkEditPanel && (
            <div className="bg-white rounded shadow p-6 mb-6 border-2 border-orange-500">
              <h3 className="text-xl font-bold mb-4">
                Bulk Edit {selectedItems.length} Selected Items
              </h3>
              
              <div className="grid md:grid-cols-2 gap-6">
                {/* Change Category */}
                <div className="border rounded p-4">
                  <h4 className="font-bold mb-3">Change Category</h4>
                  <div className="space-y-2">
                    {cats.map(cat => (
                      <button
                        key={cat}
                        onClick={() => bulkUpdateCategory(cat)}
                        className="w-full text-left px-3 py-2 bg-gray-100 hover:bg-blue-100 rounded"
                      >
                        {cat.replace(/_/g, ' ').toUpperCase()}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Change Brand */}
                <div className="border rounded p-4">
                  <h4 className="font-bold mb-3">Change Brand</h4>
                  <input
                    type="text"
                    placeholder="Enter new brand name"
                    className="w-full border rounded px-3 py-2 mb-2"
                    onKeyPress={(e) => {
                      if (e.key === 'Enter') {
                        bulkUpdateBrand(e.target.value);
                        e.target.value = '';
                      }
                    }}
                  />
                  <p className="text-xs text-gray-600">Press Enter to apply</p>
                </div>

                {/* Update Prices */}
                <div className="border rounded p-4">
                  <h4 className="font-bold mb-3">Update Prices</h4>
                  <div className="space-y-2">
                    <div className="flex gap-2">
                      <input
                        type="number"
                        step="0.01"
                        placeholder="Amount"
                        id="bulk-price-input"
                        className="flex-1 border rounded px-3 py-2"
                      />
                      <button
                        onClick={() => {
                          const val = document.getElementById('bulk-price-input').value;
                          bulkUpdatePrice(val, 'add');
                        }}
                        className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                      >
                        Add
                      </button>
                    </div>
                    <div className="flex gap-2">
                      <input
                        type="number"
                        step="0.01"
                        placeholder="Multiplier (e.g., 1.1 for +10%)"
                        id="bulk-multiply-input"
                        className="flex-1 border rounded px-3 py-2"
                      />
                      <button
                        onClick={() => {
                          const val = document.getElementById('bulk-multiply-input').value;
                          bulkUpdatePrice(val, 'multiply');
                        }}
                        className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                      >
                        Multiply
                      </button>
                    </div>
                    <div className="flex gap-2">
                      <input
                        type="number"
                        step="0.01"
                        placeholder="New price"
                        id="bulk-set-input"
                        className="flex-1 border rounded px-3 py-2"
                      />
                      <button
                        onClick={() => {
                          const val = document.getElementById('bulk-set-input').value;
                          bulkUpdatePrice(val, 'set');
                        }}
                        className="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700"
                      >
                        Set
                      </button>
                    </div>
                  </div>
                </div>

                {/* Update Vendor Information */}
                <div className="border rounded p-4">
                  <h4 className="font-bold mb-3">Update Vendor Info</h4>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-xs text-gray-600 mb-1">Vendor Name</label>
                      <input
                        type="text"
                        placeholder="Vendor name"
                        className="w-full border rounded px-3 py-2 text-sm"
                        onKeyPress={(e) => {
                          if (e.key === 'Enter') {
                            bulkUpdateVendor('vendor_name', e.target.value);
                            e.target.value = '';
                          }
                        }}
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-600 mb-1">Quote Reference</label>
                      <input
                        type="text"
                        placeholder="Quote ref #"
                        className="w-full border rounded px-3 py-2 text-sm"
                        onKeyPress={(e) => {
                          if (e.key === 'Enter') {
                            bulkUpdateVendor('vendor_quote_ref', e.target.value);
                            e.target.value = '';
                          }
                        }}
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-gray-600 mb-1">Vendor Contact</label>
                      <input
                        type="text"
                        placeholder="Phone / email / website"
                        className="w-full border rounded px-3 py-2 text-sm"
                        onKeyPress={(e) => {
                          if (e.key === 'Enter') {
                            bulkUpdateVendor('vendor_link', e.target.value);
                            e.target.value = '';
                          }
                        }}
                      />
                    </div>
                    <p className="text-xs text-gray-600">Press Enter to apply</p>
                  </div>
                </div>

                {/* Bulk Delete */}
                <div className="border rounded p-4 border-red-300">
                  <h4 className="font-bold mb-3 text-red-700">Danger Zone</h4>
                  <button
                    onClick={bulkDelete}
                    className="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                  >
                    Delete {selectedItems.length} Items
                  </button>
                  <p className="text-xs text-red-600 mt-2">This cannot be undone!</p>
                </div>
              </div>
            </div>
          )}

          <div className="bg-white rounded shadow p-6 mb-6">
            <h3 className="text-xl font-bold mb-4">
              {editingId ? '‚úèÔ∏è Edit Item' : '‚ûï Add New Item'}
            </h3>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block font-semibold mb-2 text-sm">Category *</label>
                <select
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                  className="border rounded px-3 py-2 w-full"
                >
                  <optgroup label="üö∞ BASIN ZONE">
                    <option value="basin">Basin</option>
                    <option value="mixer">Basin Mixer</option>
                    <option value="concealed_body">Concealed Body</option>
                    {customCategories.filter(cat => {
                      const zone = typeof cat === 'string' ? null : cat.zone;
                      return zone === 'basin';
                    }).map((cat, idx) => {
                      const catName = typeof cat === 'string' ? cat : cat.name;
                      const catKey = catName.toLowerCase().replace(/\s+/g, '_');
                      return <option key={idx} value={catKey}>{catName}</option>;
                    })}
                  </optgroup>
                  <optgroup label="üöΩ WC ZONE">
                    <option value="wc">WC</option>
                    <option value="health_faucet">Health Faucet</option>
                    {customCategories.filter(cat => {
                      const zone = typeof cat === 'string' ? null : cat.zone;
                      return zone === 'wc';
                    }).map((cat, idx) => {
                      const catName = typeof cat === 'string' ? cat : cat.name;
                      const catKey = catName.toLowerCase().replace(/\s+/g, '_');
                      return <option key={idx} value={catKey}>{catName}</option>;
                    })}
                  </optgroup>
                  <optgroup label="üöø SHOWER ZONE">
                    <option value="hand_shower">Hand Shower</option>
                    <option value="hand_shower_hose">Hand Shower Hose</option>
                    <option value="hand_shower_outlet">Hand Shower Wall Outlet</option>
                    <option value="hand_shower_rail">Hand Shower Rail</option>
                    <option value="overhead_shower">Overhead Shower</option>
                    <option value="shower_arm">Shower Arm</option>
                    <option value="diverter">Diverter</option>
                    <option value="diverter_concealed_body">Diverter Concealed Body</option>
                    <option value="shower_panel">Shower Panel</option>
                    <option value="geyser">Geyser</option>
                    {customCategories.filter(cat => {
                      const zone = typeof cat === 'string' ? null : cat.zone;
                      return zone === 'shower';
                    }).map((cat, idx) => {
                      const catName = typeof cat === 'string' ? cat : cat.name;
                      const catKey = catName.toLowerCase().replace(/\s+/g, '_');
                      return <option key={idx} value={catKey}>{catName}</option>;
                    })}
                  </optgroup>
                  <optgroup label="üîß ACCESSORIES ZONE">
                    <option value="shower_drain">Shower Drain</option>
                    <option value="floor_drain_wc">Floor Drain near WC</option>
                    <option value="toilet_paper_holder">Toilet Paper Holder</option>
                    <option value="hand_towel_rail">Hand Towel Rail</option>
                    <option value="towel_rack">Towel Rack</option>
                    <option value="robe_hook">Robe Hook</option>
                    <option value="drain">Drain</option>
                    <option value="accessory">Other Accessory</option>
                    {customCategories.filter(cat => {
                      const zone = typeof cat === 'string' ? null : cat.zone;
                      return zone === 'accessories';
                    }).map((cat, idx) => {
                      const catName = typeof cat === 'string' ? cat : cat.name;
                      const catKey = catName.toLowerCase().replace(/\s+/g, '_');
                      return <option key={idx} value={catKey}>{catName}</option>;
                    })}
                  </optgroup>
                  <optgroup label="üèóÔ∏è TILES ZONE">
                    <option value="wall_tiles">Wall Tiles</option>
                    <option value="feature_wall_tiles">Feature Wall Tiles</option>
                    <option value="floor_tiles">Floor Tiles</option>
                    {customCategories.filter(cat => {
                      const zone = typeof cat === 'string' ? null : cat.zone;
                      return zone === 'tiles';
                    }).map((cat, idx) => {
                      const catName = typeof cat === 'string' ? cat : cat.name;
                      const catKey = catName.toLowerCase().replace(/\s+/g, '_');
                      return <option key={idx} value={catKey}>{catName}</option>;
                    })}
                  </optgroup>
                  {customCategories.some(cat => {
                    const zone = typeof cat === 'string' ? null : cat.zone;
                    return zone === 'lighting';
                  }) && (
                    <optgroup label="üí° LIGHTING ZONE">
                      {customCategories.filter(cat => {
                        const zone = typeof cat === 'string' ? null : cat.zone;
                        return zone === 'lighting';
                      }).map((cat, idx) => {
                        const catName = typeof cat === 'string' ? cat : cat.name;
                        const catKey = catName.toLowerCase().replace(/\s+/g, '_');
                        return <option key={idx} value={catKey}>{catName}</option>;
                      })}
                    </optgroup>
                  )}
                  {customCategories.some(cat => {
                    const zone = typeof cat === 'string' ? null : cat.zone;
                    return zone === 'general' || !zone;
                  }) && (
                    <optgroup label="üì¶ GENERAL">
                      {customCategories.filter(cat => {
                        const zone = typeof cat === 'string' ? null : cat.zone;
                        return zone === 'general' || !zone;
                      }).map((cat, idx) => {
                        const catName = typeof cat === 'string' ? cat : cat.name;
                        const catKey = catName.toLowerCase().replace(/\s+/g, '_');
                        return <option key={idx} value={catKey}>{catName}</option>;
                      })}
                    </optgroup>
                  )}
                </select>
              </div>
              
              <input
                value={brand}
                onChange={(e) => setBrand(e.target.value)}
                placeholder="Brand *"
                className="border rounded px-3 py-2"
              />
              
              <input
                value={model}
                onChange={(e) => setModel(e.target.value)}
                placeholder="Model *"
                className="border rounded px-3 py-2"
              />
              
              <input
                value={series}
                onChange={(e) => setSeries(e.target.value)}
                placeholder="Series"
                className="border rounded px-3 py-2"
              />
              
              <input
                value={price}
                onChange={(e) => setPrice(e.target.value)}
                type="number"
                step="0.01"
                placeholder={`Price (${currency})`}
                className="border rounded px-3 py-2"
              />
              
              <input
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="Description"
                className="border rounded px-3 py-2 col-span-2"
              />

              <div className="col-span-2">
                <label className="block font-semibold mb-2">
                  Related Items (Model Numbers)
                  <span className="text-xs text-gray-500 font-normal ml-2">
                    Enter model numbers of items that should be auto-selected, separated by commas
                  </span>
                </label>
                <input
                  value={relatedItems}
                  onChange={(e) => setRelatedItems(e.target.value)}
                  placeholder="e.g., ALD-783N, ALD-233N"
                  className="border rounded px-3 py-2 w-full"
                />
                <p className="text-xs text-gray-600 mt-1">
                  Example: For diverter LYR-CHR-38783NK, enter "ALD-783N" to auto-select its concealed body
                </p>
              </div>

              {/* Vendor Information Section */}
              <div className="col-span-2 border-t pt-4">
                <h4 className="font-semibold mb-3 text-gray-700">üì¶ Vendor Information (Optional)</h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <input
                    value={vendorName}
                    onChange={(e) => setVendorName(e.target.value)}
                    placeholder="Vendor Name"
                    className="border rounded px-3 py-2"
                  />
                  <input
                    value={vendorQuoteRef}
                    onChange={(e) => setVendorQuoteRef(e.target.value)}
                    placeholder="Quote Reference"
                    className="border rounded px-3 py-2"
                  />
                  <input
                    value={vendorLink}
                    onChange={(e) => setVendorLink(e.target.value)}
                    placeholder="Vendor Link or Contact"
                    className="border rounded px-3 py-2"
                  />
                </div>
                <p className="text-xs text-gray-600 mt-2">
                  Track vendor details for procurement. These fields are optional and won't affect pricing.
                </p>
              </div>

              <div className="col-span-2 border-2 border-dashed border-gray-300 rounded p-4">
                <label className="block font-semibold mb-2">Image (Optional)</label>

                <div className="mb-3">
                  <label className="block text-sm text-gray-600 mb-1">
                    Option 1: Upload Image (Recommended, max 2MB)
                  </label>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleImageUpload}
                    className="border rounded px-3 py-2 w-full"
                  />
                  {uploadedImage && (
                    <div className="mt-2 flex items-center gap-2">
                      <img
                        src={uploadedImage}
                        alt="Preview"
                        className="w-16 h-16 object-cover rounded border"
                      />
                      <span className="text-green-600 text-sm">‚úì Image uploaded</span>
                      <button
                        type="button"
                        onClick={() => setUploadedImage(null)}
                        className="text-red-600 text-sm hover:text-red-700"
                      >
                        Remove
                      </button>
                    </div>
                  )}
                </div>

                <div className="border-t pt-3">
                  <label className="block text-sm text-gray-600 mb-1">Option 2: Image URL</label>
                  <input
                    value={imageUrl}
                    onChange={(e) => setImageUrl(e.target.value)}
                    placeholder="https://example.com/image.jpg"
                    className="border rounded px-3 py-2 w-full"
                    disabled={!!uploadedImage}
                  />
                </div>
              </div>

              <div className="col-span-2 flex gap-2">
                {editingId ? (
                  <>
                    <button
                      onClick={update}
                      className="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700"
                    >
                      UPDATE ITEM
                    </button>
                    <button
                      onClick={clear}
                      className="px-6 bg-gray-400 text-white py-2 rounded hover:bg-gray-500"
                    >
                      Cancel
                    </button>
                  </>
                ) : (
                  <button
                    onClick={add}
                    className="flex-1 bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700"
                  >
                    ADD ITEM
                  </button>
                )}
              </div>
            </div>
          </div>

          <div className="bg-white rounded shadow p-6">
            <div className="flex justify-between mb-4">
              <h3 className="text-xl font-bold">Items List ({filtered.length})</h3>
              <select
                value={filterCat}
                onChange={(e) => setFilterCat(e.target.value)}
                className="border rounded px-3 py-2"
              >
                <option value="all">All Categories</option>
                {cats.map(c => (
                  <option key={c} value={c}>
                    {c.replace(/_/g, ' ').toUpperCase()}
                  </option>
                ))}
              </select>
            </div>

            {items.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                ‚ö†Ô∏è
                <p className="text-lg">No items in database</p>
                <p className="text-sm">Add items manually or import from Excel/JSON</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      {bulkEditMode && (
                        <th className="px-4 py-2 text-left">
                          <input
                            type="checkbox"
                            checked={selectedItems.length === filtered.length && filtered.length > 0}
                            onChange={(e) => {
                              if (e.target.checked) {
                                selectAllFiltered();
                              } else {
                                deselectAll();
                              }
                            }}
                          />
                        </th>
                      )}
                      <th className="px-4 py-2 text-left">Image</th>
                      <th 
                        className="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 select-none"
                        onClick={() => handleSort('category')}
                        title="Click to sort"
                      >
                        <div className="flex items-center gap-1">
                          Category
                          {sortConfig.column === 'category' && (
                            <span className="text-xs">
                              {sortConfig.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
                            </span>
                          )}
                        </div>
                      </th>
                      <th 
                        className="px-4 py-2 text-left cursor-pointer hover:bg-gray-100 select-none"
                        onClick={() => handleSort('brand')}
                        title="Click to sort"
                      >
                        <div className="flex items-center gap-1">
                          Brand
                          {sortConfig.column === 'brand' && (
                            <span className="text-xs">
                              {sortConfig.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
                            </span>
                          )}
                        </div>
                      </th>
                      <th className="px-4 py-2 text-left">Model</th>
                      <th className="px-4 py-2 text-left">Price</th>
                      {!bulkEditMode && <th className="px-4 py-2 text-left">Actions</th>}
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.map(item => (
                      <tr 
                        key={item.item_id} 
                        className={`border-t hover:bg-gray-50 ${
                          selectedItems.includes(item.item_id) ? 'bg-blue-50' : ''
                        }`}
                      >
                        {bulkEditMode && (
                          <td className="px-4 py-2">
                            <input
                              type="checkbox"
                              checked={selectedItems.includes(item.item_id)}
                              onChange={(e) => {
                                e.stopPropagation();
                                toggleItemSelection(item.item_id);
                              }}
                            />
                          </td>
                        )}
                        <td className="px-4 py-2">
                          {item.image_data ? (
                            <img
                              src={item.image_data}
                              alt={item.model}
                              className="w-16 h-16 object-cover rounded border"
                            />
                          ) : item.image_url ? (
                            <img
                              src={item.image_url}
                              alt={item.model}
                              className="w-16 h-16 object-cover rounded border"
                              onError={(e) => {
                                e.target.src =
                                  'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="64" height="64"%3E%3Crect fill="%23ddd" width="64" height="64"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999" font-size="12"%3ENo Image%3C/text%3E%3C/svg%3E';
                              }}
                            />
                          ) : (
                            <div className="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">
                              No Image
                            </div>
                          )}
                        </td>
                        <td className="px-4 py-2 text-sm">
                          <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                            {getCategoryLabel(item.category)}
                          </span>
                        </td>
                        <td className="px-4 py-2">{item.brand}</td>
                        <td className="px-4 py-2">{item.model}</td>
                        <td className="px-4 py-2">
                          {(item.unit_price ?? item.price) ? `${currency}${(item.unit_price ?? item.price).toFixed(2)}` : 'TBA'}
                        </td>
                        {!bulkEditMode && (
                          <td className="px-4 py-2">
                            <div className="flex gap-2">
                              <button
                                onClick={() => edit(item)}
                                className="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
                              >
                                Edit
                              </button>
                              <button
                                onClick={() => del(item.item_id)}
                                className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
                              >
                                Delete
                              </button>
                            </div>
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )}

      {view === 'configure' && <ConfigureBathrooms />}
      {view === 'compare' && <CompareOptions />}
      {view === 'summary' && <OptionSummary />}
      {view === 'overview' && <BathroomOverview />}
      {view === 'procurement' && <ProcurementList />}
      
      {view === 'settings' && (
        <div className="max-w-4xl mx-auto p-6">
          <h2 className="text-3xl font-bold mb-6">‚öôÔ∏è Settings</h2>
          
          <div className="space-y-6">
            {/* Currency Settings */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-bold mb-4">üí± Currency</h3>
              <p className="text-gray-600 mb-4">
                Current currency: <strong>{currencyCode}</strong> ({currency})
              </p>
              
              <div className="grid grid-cols-2 gap-3">
                {[
                  { code: 'INR', symbol: '‚Çπ', name: 'Indian Rupee' },
                  { code: 'USD', symbol: '$', name: 'US Dollar' },
                  { code: 'EUR', symbol: '‚Ç¨', name: 'Euro' },
                  { code: 'GBP', symbol: '¬£', name: 'British Pound' },
                  { code: 'AED', symbol: 'AED', name: 'UAE Dirham' },
                  { code: 'SGD', symbol: 'S$', name: 'Singapore Dollar' },
                  { code: 'AUD', symbol: 'A$', name: 'Australian Dollar' },
                  { code: 'CAD', symbol: 'C$', name: 'Canadian Dollar' }
                ].map(curr => (
                  <button
                    key={curr.code}
                    onClick={async () => {
                      setCurrency(curr.symbol);
                      setCurrencyCode(curr.code);
                      try {
                        if (window.storage && typeof window.storage.set === 'function') {
                          await window.storage.set('currency-settings', JSON.stringify({ symbol: curr.symbol, code: curr.code }));
                        } else {
                          localStorage.setItem('currency-settings', JSON.stringify({ symbol: curr.symbol, code: curr.code }));
                        }
                      } catch (err) {
                        debug(`Currency save warning: ${err.message}`);
                      }
                      setNotification({ type: 'success', message: `Currency changed to ${curr.code}` });
                      setTimeout(() => setNotification(null), 3000);
                      debug(`‚úì Currency changed to ${curr.code}`);
                    }}
                    className={`px-4 py-3 border-2 rounded-lg text-left transition-colors ${
                      currencyCode === curr.code
                        ? 'border-blue-500 bg-blue-50'
                        : 'border-gray-300 hover:border-blue-300 hover:bg-gray-50'
                    }`}
                  >
                    <div className="font-semibold">{curr.symbol} {curr.code}</div>
                    <div className="text-sm text-gray-600">{curr.name}</div>
                  </button>
                ))}
              </div>
              
              <p className="text-xs text-gray-500 mt-4">
                üí° Note: This changes the display symbol only. Enter prices in whatever currency you're using.
              </p>
            </div>
            
            {/* Data Management */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-bold mb-4">üíæ Data Management</h3>
              
              <div className="space-y-3">
                <div className="flex justify-between items-center p-3 bg-gray-50 rounded">
                  <div>
                    <div className="font-semibold">Items in Database</div>
                    <div className="text-sm text-gray-600">{items.length} products</div>
                  </div>
                </div>
                
                <div className="flex justify-between items-center p-3 bg-gray-50 rounded">
                  <div>
                    <div className="font-semibold">Bathrooms Configured</div>
                    <div className="text-sm text-gray-600">{bathrooms.length} bathrooms</div>
                  </div>
                </div>
                
                <div className="flex justify-between items-center p-3 bg-gray-50 rounded">
                  <div>
                    <div className="font-semibold">Storage Status</div>
                    <div className="text-sm text-gray-600">
                      {storageAvailable ? '‚úÖ Available' : '‚ö†Ô∏è Unavailable - use Export'}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Custom Categories */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-bold mb-4">üè∑Ô∏è Custom Categories</h3>
              <p className="text-gray-600 mb-4">
                Add your own product categories beyond the default ones. Assign them to zones (Basin, WC, Shower, General) for better organization.
              </p>
              
              <div className="space-y-3 mb-4">
                {customCategories.length > 0 && (
                  <div className="border rounded-lg p-3 bg-purple-50">
                    <h4 className="font-semibold text-sm text-gray-700 mb-2">Your Custom Categories:</h4>
                    <div className="space-y-2">
                      {customCategories.map((cat, idx) => {
                        // Handle both old format (string) and new format ({name, zone})
                        const catName = typeof cat === 'string' ? cat : cat.name;
                        const catZone = typeof cat === 'string' ? 'General' : (cat.zone || 'General');
                        
                        return (
                          <div key={idx} className="flex items-center justify-between bg-white px-3 py-2 rounded border border-purple-200">
                            <div className="flex items-center gap-3">
                              <span className="font-semibold text-purple-900">{catName}</span>
                              <span className="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded">
                                Zone: {catZone}
                              </span>
                            </div>
                            <button
                              onClick={async () => {
                                const newCategories = customCategories.filter((_, i) => i !== idx);
                                setCustomCategories(newCategories);
                                await saveToStorage({ categories: newCategories });
                                debug(`Removed custom category: ${catName}`);
                                setNotification({ type: 'success', message: `Category "${catName}" removed` });
                                setTimeout(() => setNotification(null), 2000);
                              }}
                              className="px-2 py-1 text-red-600 hover:bg-red-100 rounded text-sm font-bold"
                            >
                              Delete
                            </button>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <input
                    type="text"
                    id="new-category-input"
                    placeholder="Category name (e.g., 'Lighting')"
                    className="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none"
                  />
                  <select
                    id="new-category-zone"
                    defaultValue=""
                    className="border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none"
                  >
                    <option value="" disabled>Select Zone *</option>
                    <option value="basin">Basin Zone</option>
                    <option value="wc">WC Zone</option>
                    <option value="shower">Shower Zone</option>
                    <option value="accessories">Accessories Zone</option>
                    <option value="tiles">Tiles Zone</option>
                    <option value="lighting">Lighting Zone</option>
                    <option value="general">General</option>
                  </select>
                  <button
                    onClick={async () => {
                      const nameInput = document.getElementById('new-category-input');
                      const zoneSelect = document.getElementById('new-category-zone');
                      const newCat = nameInput.value.trim();
                      const newZone = zoneSelect.value;
                      
                      // Validate inputs
                      if (!newCat) {
                        setNotification({ type: 'error', message: 'Please enter a category name' });
                        setTimeout(() => setNotification(null), 2000);
                        return;
                      }
                      if (!newZone) {
                        setNotification({ type: 'error', message: 'Please select a zone' });
                        setTimeout(() => setNotification(null), 2000);
                        return;
                      }
                      
                      if (!customCategories.some(c => (typeof c === 'string' ? c : c.name) === newCat)) {
                        const updated = [...customCategories, { name: newCat, zone: newZone }];
                        setCustomCategories(updated);
                        await saveToStorage({ categories: updated });
                        debug(`Added custom category: ${newCat} (${newZone})`);
                        nameInput.value = '';
                        zoneSelect.value = '';
                        setNotification({ type: 'success', message: `Category "${newCat}" added!` });
                        setTimeout(() => setNotification(null), 2000);
                      } else {
                        setNotification({ type: 'error', message: `Category "${newCat}" already exists` });
                        setTimeout(() => setNotification(null), 2000);
                      }
                    }}
                    className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold"
                  >
                    Add Category
                  </button>
                </div>
              </div>
              
              <p className="text-xs text-gray-500">
                üí° Custom categories will appear in the Database tab when adding/editing items. Zone assignment helps with organization in the Configure tab.
              </p>
            </div>

            {/* Debug Log - Collapsible for Power Users */}
            <div className="bg-white rounded-lg shadow p-6">
              <div 
                className="flex justify-between items-center cursor-pointer hover:bg-gray-50 -m-6 p-6 rounded-lg"
                onClick={() => {
                  const logContent = document.getElementById('debug-log-content');
                  const arrow = document.getElementById('debug-log-arrow');
                  if (logContent.classList.contains('hidden')) {
                    logContent.classList.remove('hidden');
                    arrow.textContent = '‚ñº';
                  } else {
                    logContent.classList.add('hidden');
                    arrow.textContent = '‚ñ∂';
                  }
                }}
              >
                <div>
                  <h3 className="text-xl font-bold">üêõ Debug Log</h3>
                  <p className="text-gray-600 text-sm mt-1">
                    For troubleshooting and technical support
                  </p>
                </div>
                <span id="debug-log-arrow" className="text-gray-500 text-2xl font-bold">‚ñ∂</span>
              </div>
              
              <div id="debug-log-content" className="hidden mt-4 pt-4 border-t">
                {log.length > 0 ? (
                  <div className="bg-gray-900 rounded-lg p-4">
                    <div className="flex justify-between items-center mb-3">
                      <span className="text-green-400 font-bold text-sm">Log Entries: {log.length}</span>
                      <div className="flex gap-2">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            navigator.clipboard.writeText(log.join('\n'))
                              .then(() => {
                                setNotification({ type: 'success', message: 'Log copied to clipboard!' });
                                setTimeout(() => setNotification(null), 2000);
                              });
                          }}
                          className="text-blue-400 text-xs hover:text-blue-300 px-3 py-1 bg-gray-800 rounded font-semibold"
                        >
                          üìã Copy
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setLog([]);
                            setNotification({ type: 'success', message: 'Log cleared' });
                            setTimeout(() => setNotification(null), 1500);
                          }}
                          className="text-red-400 text-xs hover:text-red-300 px-3 py-1 bg-gray-800 rounded font-semibold"
                        >
                          üóëÔ∏è Clear
                        </button>
                      </div>
                    </div>
                    <div className="max-h-80 overflow-y-auto text-green-400 font-mono text-xs space-y-1">
                      {log.map((l, i) => (
                        <div key={i} className="border-b border-gray-800 py-1 px-2 hover:bg-gray-800">{l}</div>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div className="bg-gray-100 rounded-lg p-6 text-center text-gray-600 text-sm">
                    <div className="text-4xl mb-2">üìù</div>
                    <p>No log entries yet</p>
                    <p className="text-xs mt-1">System events and actions will appear here</p>
                  </div>
                )}
              </div>
            </div>
            
            {/* Clear All Data - Danger Zone */}
            <div className="bg-red-50 rounded-lg shadow p-6 border-2 border-red-300">
              <h3 className="text-xl font-bold mb-3 text-red-700">‚ö†Ô∏è Danger Zone</h3>
              <p className="text-gray-700 mb-4">
                Clear all data and start fresh. This action cannot be undone!
              </p>
              <button
                onClick={async () => {
                  if (window.confirm('‚ö†Ô∏è WARNING: This will delete ALL your data including items, bathrooms, configurations, and settings. This cannot be undone!\n\nAre you absolutely sure?')) {
                    if (window.confirm('Final confirmation: Delete everything and start over?')) {
                      try {
                        // Clear all state
                        setItems([]);
                        setBathrooms([]);
                        setFinalSelections({});
                        setCustomCategories([]);
                        setLog([]);
                        
                        // Clear storage
                        if (window.storage && typeof window.storage.delete === 'function') {
                          await window.storage.delete('bathroom-items-v2');
                          await window.storage.delete('bathrooms-v2');
                          await window.storage.delete('selections-v2');
                          await window.storage.delete('categories-v2');
                        } else {
                          localStorage.removeItem('bathroom-items-v2');
                          localStorage.removeItem('bathrooms-v2');
                          localStorage.removeItem('selections-v2');
                          localStorage.removeItem('categories-v2');
                        }
                        
                        debug('‚úì All data cleared');
                        setNotification({ type: 'success', message: 'All data cleared! Starting fresh.' });
                        setTimeout(() => {
                          setNotification(null);
                          setView('database');
                        }, 2000);
                      } catch (error) {
                        debug(`‚ö†Ô∏è Error clearing data: ${error.message}`);
                        setNotification({ type: 'error', message: 'Error clearing some data. Check debug log.' });
                        setTimeout(() => setNotification(null), 3000);
                      }
                    }
                  }
                }}
                className="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition"
              >
                üóëÔ∏è Clear All Data
              </button>
              <p className="text-xs text-red-600 mt-3 font-semibold">
                ‚ö° TIP: Export a backup before clearing if you might want to restore later!
              </p>
            </div>
            
            {/* About & Support */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow p-6 border border-blue-200">
              <h3 className="text-xl font-bold mb-3">‚ÑπÔ∏è About</h3>
              <p className="text-gray-700 mb-2">
                <strong>Bathroom Planner</strong> v3.0
              </p>
              <p className="text-sm text-gray-600 mb-4">
                Created by <a href="https://www.linkedin.com/in/poojasengupta/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-semibold">Pooja Sengupta</a> with Claude AI
              </p>
              <a 
                href="https://www.buymeacoffee.com/poojasengupta" 
                target="_blank" 
                rel="noopener noreferrer"
                className="inline-flex items-center gap-2 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold px-5 py-2.5 rounded-lg transition shadow-md"
              >
                ‚òï Buy me a coffee
              </a>
              <p className="text-xs text-gray-500 mt-4">
                ¬© 2026 ‚Ä¢ Built with React ‚Ä¢ May your bathroom renovations be stress-free! ‚ú®
              </p>
            </div>
          </div>
        </div>
      )}
      
      {view === 'help' && (
        <div className="max-w-5xl mx-auto p-6">
          <h2 className="text-3xl font-bold mb-6">‚ùì Help & Guide</h2>
          
          <div className="space-y-6">
            {/* Onboarding */}
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg shadow-lg p-6">
              <h3 className="text-2xl font-bold mb-3">üõÅ New to Bathroom Planner?</h3>
              <p className="mb-4 text-blue-100">
                Learn how to use this tool with our interactive onboarding guide.
              </p>
              <button
                onClick={() => setShowOnboarding(true)}
                className="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition"
              >
                Launch Onboarding Guide
              </button>
            </div>

            {/* Quick Start */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-2xl font-bold mb-4 text-blue-600">üöÄ Quick Start</h3>
              <ol className="list-decimal list-inside space-y-2 text-gray-700">
                <li><strong>Add Products:</strong> Go to <span className="bg-gray-200 px-2 py-1 rounded">Database</span> tab and add your bathroom fittings</li>
                <li><strong>Create Bathrooms:</strong> Go to <span className="bg-gray-200 px-2 py-1 rounded">Bathrooms</span> tab and add your bathrooms</li>
                <li><strong>Configure Options:</strong> Go to <span className="bg-gray-200 px-2 py-1 rounded">Configure</span> tab and select products for each option</li>
                <li><strong>Compare:</strong> Use <span className="bg-gray-200 px-2 py-1 rounded">Summary</span> to compare options side-by-side</li>
                <li><strong>Review:</strong> Use <span className="bg-gray-200 px-2 py-1 rounded">Overview</span> for a project-wide view</li>
                <li><strong>Procure:</strong> Use <span className="bg-gray-200 px-2 py-1 rounded">Procurement</span> to get quantities by brand</li>
              </ol>
            </div>
            
            {/* Database Tab */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-bold mb-3">üìä Database Tab</h3>
              <p className="text-gray-700 mb-3">Add all your bathroom products here first.</p>
              <ul className="list-disc list-inside space-y-1 text-gray-600 text-sm">
                <li><strong>Category:</strong> Choose from Basin Zone, WC Zone, Shower Zone, Accessories, or Tiles</li>
                <li><strong>Brand & Model:</strong> Required fields</li>
                <li><strong>Price:</strong> Enter unit price in your currency</li>
                <li><strong>Image:</strong> Optional - upload or use URL</li>
                <li><strong>Related Items:</strong> For auto-selection (e.g., diverter ‚Üí concealed body)</li>
              </ul>
            </div>
            
            {/* Bathrooms Tab */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-bold mb-3">üöø Bathrooms Tab</h3>
              <p className="text-gray-700 mb-3">Create your bathrooms and define how many options to compare.</p>
              <ul className="list-disc list-inside space-y-1 text-gray-600 text-sm">
                <li><strong>Name:</strong> e.g., "Master Bathroom", "Guest Bath"</li>
                <li><strong>Importance:</strong> High/Medium/Low for prioritization</li>
                <li><strong>Number of Options:</strong> How many alternatives to compare (1-5)</li>
                <li><strong>Renders:</strong> Upload bathroom renders/photos for reference</li>
              </ul>
            </div>
            
            {/* Configure Tab */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-bold mb-3">‚öôÔ∏è Configure Tab</h3>
              <p className="text-gray-700 mb-3">Select products for each option. Products are organized by zones.</p>
              <ul className="list-disc list-inside space-y-1 text-gray-600 text-sm">
                <li><strong>Zones:</strong> Basin, WC, Shower, Accessories, Tiles</li>
                <li><strong>Auto-selected items:</strong> Some items (like concealed bodies) auto-select</li>
                <li><strong>Optional items:</strong> Check boxes to include (e.g., Geyser, Towel Rack)</li>
                <li><strong>Add/Duplicate/Delete:</strong> Manage options easily</li>
              </ul>
            </div>
            
            {/* Export Features */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-bold mb-3">üì§ Export & Share</h3>
              <div className="space-y-3">
                <div>
                  <h4 className="font-semibold text-gray-800">Export to PDF</h4>
                  <p className="text-sm text-gray-600">Available in Summary, Overview, and Procurement tabs. Click the purple "Export PDF" button, then use your browser's Print dialog to save as PDF.</p>
                </div>
                <div>
                  <h4 className="font-semibold text-gray-800">Export to Excel</h4>
                  <p className="text-sm text-gray-600">In Procurement tab, click "Export Excel" to download a spreadsheet with quantities and pricing.</p>
                </div>
                <div>
                  <h4 className="font-semibold text-gray-800">Backup Data</h4>
                  <p className="text-sm text-gray-600">In Database tab, use "Export Backup" to save all your data. Use "Import Backup" to restore.</p>
                </div>
              </div>
            </div>
            
            {/* Tips & Tricks */}
            <div className="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg shadow p-6 border border-yellow-200">
              <h3 className="text-xl font-bold mb-3">üí° Tips & Tricks</h3>
              <ul className="list-disc list-inside space-y-2 text-gray-700 text-sm">
                <li><strong>Related Items:</strong> When adding a diverter, specify its concealed body in "Related Items" for auto-selection</li>
                <li><strong>Multiple Options:</strong> Create 2-3 options per bathroom to compare budget vs premium choices</li>
                <li><strong>Bulk Edit:</strong> In Database, select multiple items and edit them together</li>
                <li><strong>Zones:</strong> Products are organized by zones for easier navigation</li>
                <li><strong>Currency:</strong> Set your currency in Settings - it's cosmetic, enter prices in your own currency</li>
                <li><strong>Save Often:</strong> Use Export Backup regularly to save your work</li>
              </ul>
            </div>
            
            {/* Troubleshooting */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-bold mb-3">üîß Troubleshooting</h3>
              <div className="space-y-3 text-sm">
                <div>
                  <h4 className="font-semibold text-gray-800">PDF Export Not Working?</h4>
                  <p className="text-gray-600">Enable popups for this site. The export opens in a new window which may be blocked by your browser.</p>
                </div>
                <div>
                  <h4 className="font-semibold text-gray-800">Data Not Saving?</h4>
                  <p className="text-gray-600">If storage is unavailable, use "Export Backup" button to save your data manually. You can restore it later with "Import Backup".</p>
                </div>
                <div>
                  <h4 className="font-semibold text-gray-800">Can't See My Images?</h4>
                  <p className="text-gray-600">If using URLs, make sure the image URL is publicly accessible. Try uploading the image directly instead.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Footer */}
      <footer className="mt-12 border-t border-gray-300 pt-6 pb-8 px-6 bg-gradient-to-r from-blue-50 to-indigo-50">
        <div className="max-w-4xl mx-auto text-center">
          <div className="mb-4">
            <p className="text-sm text-gray-700 leading-relaxed mb-3">
              üè† <em>Born from the chaos of DIY house construction ‚Äì when spreadsheets just weren't cutting it anymore.</em> üè†
            </p>
            <p className="text-sm text-gray-600 leading-relaxed">
              What started as a desperate attempt to organize bathroom fittings for my own home renovation 
              turned into this tinkering tool. If you're also drowning in product catalogs and trying to compare 
              15 different basin options, I hope this helps you too!
            </p>
          </div>
          
          <div className="mt-4 pt-4 border-t border-gray-300">
            <p className="text-sm text-gray-700 mb-3">
              Created with ‚ù§Ô∏è by{' '}
              <a 
                href="https://www.linkedin.com/in/poojasengupta/" 
                target="_blank" 
                rel="noopener noreferrer"
                className="text-blue-600 hover:text-blue-800 font-semibold underline"
              >
                Pooja Sengupta
              </a>
              {' '}and{' '}
              <span className="font-semibold text-purple-600">Claude AI</span>
            </p>
            <a 
              href="https://www.buymeacoffee.com/poojasengupta" 
              target="_blank" 
              rel="noopener noreferrer"
              className="inline-flex items-center gap-2 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold px-5 py-2 rounded-lg transition shadow-md mb-3"
            >
              ‚òï Buy me a coffee
            </a>
            <p className="text-xs text-gray-500 mt-3">
              ¬© 2026 ‚Ä¢ Built with React ‚Ä¢ May your bathroom renovations be less stressful than mine! ‚ú®
            </p>
          </div>
        </div>
      </footer>
    </div>
  );
};


ReactDOM.render(<App />, document.getElementById('root'));
  </script>
  
  <!-- StatCounter Analytics (synchronous) -->
  <script type="text/javascript">
  var sc_project=13201711; 
  var sc_invisible=1; 
  var sc_security="a9cc5825"; 
  </script>
  <script type="text/javascript" src="https://www.statcounter.com/counter/counter.js"></script>
  <noscript>
    <div class="statcounter">
      <a title="Web Analytics" href="https://statcounter.com/" target="_blank">
        <img class="statcounter" src="https://c.statcounter.com/13201711/0/a9cc5825/1/" alt="Web Analytics" referrerPolicy="no-referrer-when-downgrade">
      </a>
    </div>
  </noscript>
</body>
</html>